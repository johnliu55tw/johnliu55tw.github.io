<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="John Liu" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Python, TTY, Linux, Python, " />

<meta property="og:title" content="ç”¨Pythonæ§åˆ¶å…¶ä»–è¡Œç¨‹çš„TTYçµ‚ç«¯è£ç½® "/>
<meta property="og:url" content="https://johnliu55.tw/use-python-to-control-other-process-tty.html" />
<meta property="og:description" content="Foreword é€™ç¯‡æ–‡ç« æœƒç¨å¾®è§£é‡‹ Unix çš„ TTY ç³»çµ±ä»¥åŠ Pseudo Terminal çš„æ¦‚å¿µï¼Œæ¥è‘—è¨è«–å¦‚ä½•ä½¿ç”¨ Python çš„ pty æ¨¡çµ„ä¸­çš„ pty.fork() ä¾†å»ºç«‹ä¸¦æ§åˆ¶å­è¡Œç¨‹çš„ TTY ç³»çµ±ï¼Œæœ€å¾Œç”¨ Python ä¾†å¯¦ä½œæ§åˆ¶ madplay é€™å€‹ CLI MP3 Playerã€‚ æœ‰å•é¡Œæ­¡è¿å¤§å®¶è©¢å•ï¼Œæœ‰ä»»ä½•éŒ¯èª¤ä¹Ÿè«‹å¤§å®¶å¹«å¿™æŒ‡æ­£ :D Python MP3 Player é€™å¹¾å¤©åœ¨ç© ReSpeaker ï¼ˆä¸€å€‹åŸºæ–¼ MT7688 çš„è²æ§è£ç½®é–‹ç™¼æ¿ï¼‰é‡åˆ°äº†å€‹å•é¡Œï¼šåœ¨ ReSpeaker ä¸­è¦å¦‚ä½•ä½¿ç”¨ Python æ’­æ”¾ MP3 æª”æ¡ˆï¼Ÿ å¥½åœ¨ ReSpeaker ä¸Šå·²æœ‰ madplay â€¦" />
<meta property="og:site_name" content="John Engineering Stuff" />
<meta property="og:article:author" content="John Liu" />
<meta property="og:article:published_time" content="2018-04-11T00:00:00+08:00" />
<meta name="twitter:title" content="ç”¨Pythonæ§åˆ¶å…¶ä»–è¡Œç¨‹çš„TTYçµ‚ç«¯è£ç½® ">
<meta name="twitter:description" content="Foreword é€™ç¯‡æ–‡ç« æœƒç¨å¾®è§£é‡‹ Unix çš„ TTY ç³»çµ±ä»¥åŠ Pseudo Terminal çš„æ¦‚å¿µï¼Œæ¥è‘—è¨è«–å¦‚ä½•ä½¿ç”¨ Python çš„ pty æ¨¡çµ„ä¸­çš„ pty.fork() ä¾†å»ºç«‹ä¸¦æ§åˆ¶å­è¡Œç¨‹çš„ TTY ç³»çµ±ï¼Œæœ€å¾Œç”¨ Python ä¾†å¯¦ä½œæ§åˆ¶ madplay é€™å€‹ CLI MP3 Playerã€‚ æœ‰å•é¡Œæ­¡è¿å¤§å®¶è©¢å•ï¼Œæœ‰ä»»ä½•éŒ¯èª¤ä¹Ÿè«‹å¤§å®¶å¹«å¿™æŒ‡æ­£ :D Python MP3 Player é€™å¹¾å¤©åœ¨ç© ReSpeaker ï¼ˆä¸€å€‹åŸºæ–¼ MT7688 çš„è²æ§è£ç½®é–‹ç™¼æ¿ï¼‰é‡åˆ°äº†å€‹å•é¡Œï¼šåœ¨ ReSpeaker ä¸­è¦å¦‚ä½•ä½¿ç”¨ Python æ’­æ”¾ MP3 æª”æ¡ˆï¼Ÿ å¥½åœ¨ ReSpeaker ä¸Šå·²æœ‰ madplay â€¦">

        <title>ç”¨Pythonæ§åˆ¶å…¶ä»–è¡Œç¨‹çš„TTYçµ‚ç«¯è£ç½®  Â· John Engineering Stuff
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://johnliu55.tw/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://johnliu55.tw/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://johnliu55.tw/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://johnliu55.tw/theme/css/admonition.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://johnliu55.tw/theme/css/custom.css" media="screen">
        <link href="https://johnliu55.tw/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="John Engineering Stuff - Full Atom Feed" />



    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="https://johnliu55.tw/"><span class=site-name>John Engineering Stuff</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="https://johnliu55.tw">Home</a></li>
                            <li ><a href="https://johnliu55.tw/pages/about.html">About</a></li>
                            <li ><a href="https://johnliu55.tw/categories">Categories</a></li>
                            <li ><a href="https://johnliu55.tw/tags">Tags</a></li>
                            <li ><a href="https://johnliu55.tw/archives">Archives</a></li>
                            <li><form class="navbar-search" action="https://johnliu55.tw/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="https://johnliu55.tw/use-python-to-control-other-process-tty.html"> ç”¨Pythonæ§åˆ¶å…¶ä»–è¡Œç¨‹çš„TTYçµ‚ç«¯è£ç½®  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <div class="section" id="foreword">
<h2>Foreword</h2>
<p>é€™ç¯‡æ–‡ç« æœƒç¨å¾®è§£é‡‹ Unix çš„ TTY ç³»çµ±ä»¥åŠ Pseudo Terminal çš„æ¦‚å¿µï¼Œæ¥è‘—è¨è«–å¦‚ä½•ä½¿ç”¨ Python çš„ <tt class="docutils literal">pty</tt> æ¨¡çµ„ä¸­çš„ <tt class="docutils literal">pty.fork()</tt>
ä¾†å»ºç«‹ä¸¦æ§åˆ¶å­è¡Œç¨‹çš„ TTY ç³»çµ±ï¼Œæœ€å¾Œç”¨ Python ä¾†å¯¦ä½œæ§åˆ¶ <em>madplay</em> é€™å€‹ CLI MP3 Playerã€‚</p>
<p>æœ‰å•é¡Œæ­¡è¿å¤§å®¶è©¢å•ï¼Œæœ‰ä»»ä½•éŒ¯èª¤ä¹Ÿè«‹å¤§å®¶å¹«å¿™æŒ‡æ­£ :D</p>
</div>
<hr class="docutils" />
<div class="section" id="python-mp3-player">
<h2>Python MP3 Player</h2>
<p>é€™å¹¾å¤©åœ¨ç© <a class="reference external" href="https://www.seeedstudio.com/ReSpeaker-Core-Based-On-MT7688-and-OpenWRT-p-2716.html">ReSpeaker</a> ï¼ˆä¸€å€‹åŸºæ–¼ MT7688 çš„è²æ§è£ç½®é–‹ç™¼æ¿ï¼‰é‡åˆ°äº†å€‹å•é¡Œï¼šåœ¨ ReSpeaker ä¸­è¦å¦‚ä½•ä½¿ç”¨ Python æ’­æ”¾ MP3 æª”æ¡ˆï¼Ÿ</p>
<p>å¥½åœ¨ ReSpeaker ä¸Šå·²æœ‰ <em>madplay</em> é€™å€‹æŒ‡ä»¤ï¼Œèƒ½å¤ ç›´æ¥æ’­æ”¾ MP3ï¼š</p>
<div class="highlight"><pre><span></span>$ madplay MP3_FILE
</pre></div>
<p>æ›´è®šçš„æ˜¯åªè¦åŠ ä¸Š <tt class="docutils literal"><span class="pre">--tty-control</span></tt> å°±èƒ½ç›´æ¥æ§åˆ¶æ’­æ”¾ç‹€æ…‹ï¼</p>
<div class="highlight"><pre><span></span>$ madplay MP3_FILE --tty-control MP3_FILE
</pre></div>
<p>ä¾‹å¦‚æŒ‰ä¸‹ <tt class="docutils literal">p</tt> å°±èƒ½æ§åˆ¶éŸ³æ¨‚æ’­æ”¾çš„æš«åœ / ç¹¼çºŒã€‚å¾ˆå¥½ï¼é€™æ¨£å°±å¯ä»¥ç”¨ <tt class="docutils literal">subprocess</tt> æ¨¡çµ„å•Ÿå‹• madplay ä¾†æ§åˆ¶éŸ³æ¨‚æ’­æ”¾å•¦ï¼ç„¶å¾Œ<strong>å°é€™å€‹å­è¡Œç¨‹çš„ stdin</strong> å¯«å…¥é€™äº›æ§åˆ¶ç”¨çš„éµæ‡‰è©²å°±èƒ½æ§åˆ¶éŸ³æ¨‚æ’­æ”¾äº†å§ï¼Ÿè‡³å°‘æˆ‘æ˜¯é€™æ¨£æƒ³çš„â€¦</p>
</div>
<div class="section" id="the-mystery-tty">
<h2>The mystery TTY</h2>
<p>ä¿—è©±èªªçš„å¥½ï¼Œä»£èªŒå¾€å¾€ä¸æ˜¯æ†¨äººæ‰€æƒ³çš„é‚£éº¼ç°¡å–®ï¼Œè©¦äº†å¹¾å›å¾Œç™¼ç¾ç«Ÿç„¶æ²’æ•ˆï¼Ÿï¼ä¸€æ°£ä¹‹ä¸‹ç¿»äº†ç¿» madplay çš„åŸå§‹ç¢¼ï¼Œç™¼ç¾ <tt class="docutils literal">player.c</tt>
è£¡æœ‰äº›è·Ÿ <em>TTY</em> é€™ç©æ„å…’æœ‰é—œçš„ç¨‹å¼ç¢¼ï¼š</p>
<div class="highlight"><pre><span></span><span class="cp"># define TTY_DEVICE &quot;/dev/tty&quot;</span>
<span class="p">...</span>
<span class="n">tty_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TTY_DEVICE</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">tty_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
<p>ç©é Linux çš„æœ‹å‹å€‘æ‡‰è©²å° TTY é€™å€‹å­—æœ‰å¼·çƒˆçš„ç†Ÿæ‚‰æ„Ÿï¼Œå¥½åƒä¸‰ä¸äº”æ™‚å°±æœƒçœ‹åˆ°é€™æ±è¥¿å‡ºç¾ã€‚æ–¼æ˜¯æˆ‘æ‹¿ä»–å» Google å¾Œå¾—åˆ°ä¸‹é¢å¹¾å€‹çµè«–ï¼š</p>
<ol class="arabic simple">
<li>TTY æºè‡ªæ–¼ <em>Teletype</em> é€™å€‹å–®å­—ï¼Œä¸­æ–‡ç¨±ç‚º<strong>é›»å‚³æ‰“å­—æ©Ÿ</strong>ï¼Œæ˜¯å¤æ—©å¹´ä»£ç”¨ä¾†é è·é›¢å‚³éæ–‡å­—è³‡è¨Šç”¨çš„æ©Ÿå™¨ä»¥åŠæ©Ÿåˆ¶ã€‚</li>
<li>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ä¸¦æ²’æœ‰ PCâ€Šâ€”â€ŠPersonal Computer é€™ç¨®æ±è¥¿ï¼Œæœ‰çš„åªæ˜¯ä¸€å°è¢å¹•åŠ éµç›¤çµ„æˆçš„çµ‚ç«¯æ©Ÿï¼Œé€éä¸²åˆ—åŸ ç­‰ç­‰çš„å‚³è¼¸æ–¹å¼èˆ‡ä¸€å°ä¸­å¤®ä¸»æ©Ÿæºé€šï¼Œé€²è¡Œæ§åˆ¶èˆ‡é‹ç®—çš„å·¥ä½œã€‚Unix ä¸‹çš„ TTY è£ç½®æ¦‚å¿µå°±æ˜¯å¾é€™è£¡å‡ºç¾çš„ï¼Œç´°ç¯€å¯åƒè€ƒæˆ‘åˆ—åœ¨æœ€å¾Œé¢çš„ Referencesã€‚</li>
<li>TTY è£ç½®æ¶æ§‹ä¸­æœ‰ä¸€å±¤å«åš <a class="reference external" href="https://en.wikipedia.org/wiki/Line_discipline">Line discipline</a> ã€‚é€™æ±è¥¿ä»‹æ–¼è»Ÿé«”å±¤ï¼ˆè¡Œç¨‹æ¥æ”¶åˆ°çš„è³‡è¨Šï¼‰å’Œé©…å‹•å±¤ï¼ˆå¯¦éš›ä¸Šèˆ‡ç¡¬é«”æ‰“äº¤é“é‚£ä¸€å±¤ï¼‰é–“ï¼Œè² è²¬å°å¾å…¶ä¸­ä¸€å±¤å‚³ééä¾†çš„è³‡è¨Šåšå‰è™•ç†ï¼Œå†å‚³åˆ°å¦ä¸€å±¤ã€‚èˆ‰ä¾‹åƒæ˜¯ Line editingï¼ˆBufferingã€Backspaceã€Echoingã€ç§»å‹•æ¸¸æ¨™ç­‰â€¦ï¼‰ã€å­—å…ƒè½‰æ›ï¼ˆ <tt class="docutils literal">\n</tt> èˆ‡ <tt class="docutils literal">\r\n</tt> äº’ç›¸è½‰æ›â€¦ï¼‰ã€æ§åˆ¶å­—å…ƒè½‰æ›ç‚ºä¿¡è™Ÿï¼ˆASCII 0x03â†’SIGINTï¼‰ç­‰ç­‰çš„åŠŸèƒ½ã€‚</li>
<li><tt class="docutils literal">/dev/tty</tt> è£ç½®ä»£è¡¨çš„æ˜¯<strong>ç›®å‰è¡Œç¨‹æ‰€é€£æ¥è‘—çš„çµ‚ç«¯ï¼ˆTerminalï¼‰è£ç½®</strong>ã€‚</li>
</ol>
<p>å¾ <tt class="docutils literal">player.c</tt> ä¸­çš„ç¨‹å¼ç¢¼çœ‹èµ·ä¾†ï¼Œmadplay æ˜¯ç›´æ¥å¾ /dev/tty é€™å€‹è£ç½®è®€å–éµç›¤è¼¸å…¥ï¼Œè€Œä¸æ˜¯å¾ stdin è®€å–ã€‚è½èµ·ä¾†æœ‰é»å¤šæ­¤ä¸€èˆ‰ï¼Œä½†é€™éº¼åšæœ‰å€‹å¥½è™•ï¼š</p>
<blockquote>
ä¸€å€‹è¡Œç¨‹å¯ä»¥åœ¨å¾ stdin æ¥æ”¶è³‡æ–™çš„åŒæ™‚ï¼Œæ¥æ”¶ä¾†è‡ªéµç›¤çš„è¨Šæ¯ã€‚</blockquote>
<p>èˆ‰ä¾‹ä¾†èªªï¼Œ <tt class="docutils literal">cat MP3_FILE | madplay <span class="pre">-â€”tty-control</span> -</tt>
é€™ä¸²æŒ‡ä»¤ä¸­çš„ madplay æœƒè®€å– stdinï¼Œè€Œ <tt class="docutils literal">cat MP3_FILE</tt> é€™å€‹æŒ‡ä»¤æœƒå°‡ <tt class="docutils literal">MP3_FILE</tt>
é€™å€‹æª”æ¡ˆè¼¸å‡ºåˆ° stdoutï¼Œä¸­é–“æˆ‘å€‘è—‰ç”± <tt class="docutils literal">|</tt> ä¾†å°‡é€™äº›è³‡æ–™å°å‘è‡³ madplay é€²è¡Œæ’­æ”¾ã€‚åœ¨é€™ä¸€é€£ä¸²äº‹æƒ…ç™¼ç”Ÿçš„åŒæ™‚ï¼Œä½¿ç”¨è€…åŒæ¨£å¯ä»¥ç”¨éµç›¤æ§åˆ¶æ’­æ”¾ç‹€æ…‹ã€‚</p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£æœ‰æ²’æœ‰è¾¦æ³•æ§åˆ¶ä¸€å€‹è¡Œç¨‹æ‰€é€£æ¥è‘—çš„çµ‚ç«¯è£ç½®å‘¢ï¼Ÿæ›´é‡è¦çš„æ˜¯ï¼ŒPython åšçš„åˆ°å—ï¼Ÿ</p>
</div>
<div class="section" id="pseudo-terminal">
<h2>Pseudo Terminal</h2>
<p>ç•¶ç„¶å¯ä»¥ï¼é‡å°æ§åˆ¶ä¸€å€‹è¡Œç¨‹çš„çµ‚ç«¯ï¼ŒPython æ¨™æº–å‡½å¼åº«æä¾›äº†
<a class="reference external" href="https://docs.python.org/3/library/pty.html">pty</a> é€™å€‹æ¨¡çµ„ä¾†è™•ç†èˆ‡ <em>Pseudo Terminal</em> æœ‰é—œçš„æ¦‚å¿µã€‚é‚£ä»€éº¼æ˜¯ Pseudo Terminalï¼Ÿ</p>
<p>ç¾åœ¨ PC ç•¶é“ï¼ŒåŸºæœ¬ä¸Šå·²ç¶“ä¸å­˜åœ¨éå»é‚£ç¨®ã€Œä½¿ç”¨ï¼ˆä¸å…·é‹ç®—èƒ½åŠ›çš„ï¼‰çµ‚ç«¯é€£ä¸Šä¸€å°é›»è…¦é€²è¡Œæ§åˆ¶èˆ‡é‹ç®—ã€çš„æƒ…å¢ƒã€‚ä½†æ˜¯æˆ‘å€‘æƒ³æŠŠ TTY é€™å€‹æ¦‚å¿µå»¶çºŒåˆ°ç¾åœ¨ç¹¼çºŒç”¨è©²æ€éº¼è¾¦ï¼Ÿæ–¼æ˜¯å°±å‡ºç¾äº† Pseudo Terminalï¼ˆæ³¨æ„ï¼šè·Ÿ Virtual Terminal æ˜¯ä¸åŒçš„æ¦‚å¿µï¼‰ã€‚</p>
<p>é—œæ–¼ä»–çš„å®šç¾©ï¼Œæˆ‘å€‘ç›´æ¥ä¾†çœ‹ä¸€ä¸‹
<a class="reference external" href="https://linux.die.net/man/7/pty">pty çš„ Linux man page</a> ï¼š</p>
<blockquote>
A pseudoterminal (sometimes abbreviated â€œptyâ€) is a pair of virtual
character devices that provide a bidirectional communication channel.
One end of the channel is called the master; the other end is called the
slave. The slave end of the pseudoterminal provides an interface that
behaves exactly like a classical terminal. A process that expects to be
connected to a terminal, can open the slave end of a pseudoterminal and
then be driven by a program that has opened the master end. Anything that is
written on the master end is provided to the process on the slave end as
though it was input typed on a terminal.</blockquote>
<p>Pseudo Terminal å»ºç«‹äº†å…©å€‹è™›æ“¬å­—å…ƒè£ç½®ï¼Œåˆ†åˆ¥ç¨±ç‚º master èˆ‡ slaveï¼Œæä¾›äº†ä¸€å€‹é›™å‘æºé€šçš„ç®¡é“ã€‚è®€å¯« slave ç«¯çš„çš„è¡Œç¨‹å¯ä»¥æŠŠè©² slave è£ç½®å®Œå…¨ç•¶ä½œæ˜¯ä¸€å€‹æ™®é€šçš„ TTY è£ç½®è»Ÿé«”å±¤ï¼Œå…·æœ‰çµ‚ç«¯çš„è¡Œç‚ºæ¨¡å¼ã€‚è€Œå¦ä¸€å€‹è¡Œç¨‹å‰‡èƒ½å° master ç«¯é€²è¡Œè®€å¯«ï¼ŒæŠŠ master ç«¯ç•¶ä½œæ˜¯ TTY è£ç½®çš„ç¡¬é«”å±¤ã€‚<strong>è€Œå…¶ä¸­å° master æˆ– slave ç«¯å¯«å…¥çš„è³‡è¨Šï¼ŒåŒæ¨£æœƒç¶“é line discipline çš„è™•ç†ï¼Œå†é€²åˆ°å¦ä¸€ç«¯ã€‚</strong></p>
<p>å€Ÿ <a class="reference external" href="http://www.linusakesson.net/programming/tty/">The TTY demystified</a> é€™ç¯‡æ–‡ç« ä¸­çš„åœ–ä¾†èªªæ˜ï¼š</p>
<img alt="How xterm works" src="https://johnliu55.tw/use-python-to-control-other-process-tty/images/how-xterm-works.png" />
<p>æ›å¥è©±èªªï¼Œå°±æ˜¯<strong>ä¸²åˆ—åŸ æ¥é ­è®Šæˆäº†ä¸€å€‹ file descriptor</strong> ã€‚æ–¼æ˜¯å‘¢ï¼Œåƒ xterm ä¹‹é¡çš„çµ‚ç«¯æ¨¡æ“¬å™¨ï¼ˆTerminal Emulatorï¼‰å°±èƒ½å¤ ä»¥ç¨‹å¼çš„æ–¹å¼å»æ¨¡æ“¬ä¸€å°å¤æ—©å¹´ä»£çµ‚ç«¯æ©Ÿï¼Œå°‡ä½¿ç”¨è€…ä½¿ç”¨çµ‚ç«¯æ©Ÿå°ä¸²åˆ—åŸ å¯«å…¥åŠè®€å–çš„è¡Œç‚ºæ¨¡å¼ï¼Œæ”¹ç‚º<strong>å¯«å…¥åŠè®€å–é€™å€‹ file descriptor</strong> ï¼Œåœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šæ¨¡æ“¬çµ‚ç«¯çš„è¼¸å…¥åŠè¼¸å‡ºã€‚</p>
<p>å¤§æ¦‚äº†è§£äº† Pseudo Terminalï¼Œæ¥ä¸‹ä¾†çœ‹çœ‹ Python æ€éº¼åšé€™ä»¶äº‹ã€‚</p>
</div>
<div class="section" id="the-pty-module">
<h2>The pty module</h2>
<p>ä¸€å¥è©±è§£é‡‹å®Œ pty æ¨¡çµ„ï¼š</p>
<blockquote>
starting another process and being able to write to and read from its
controlling terminal programmatically.</blockquote>
<p>Bingoï¼Œé€™è½èµ·ä¾†å°±æ˜¯æˆ‘æƒ³è¦çš„å•Šï¼å…¶ä¸­æˆ‘å€‘æœƒéœ€è¦ç”¨åˆ° <tt class="docutils literal">pty.fork</tt> é€™å€‹å‡½å¼ï¼š</p>
<blockquote>
<tt class="docutils literal">pty.fork()</tt> ï¼šFork ä¸€å€‹å­è¡Œç¨‹ï¼Œä¸¦è®“è©²å­è¡Œç¨‹çš„æ§åˆ¶çµ‚ç«¯æ¥ä¸Šä¸€å€‹ Pseudo Terminal çš„ slave ç«¯ã€‚çˆ¶è¡Œç¨‹æœƒå¾—åˆ°è©² Pseudo Terminal çš„ master ç«¯ï¼Œä»¥ä¸€å€‹ file descriptor è¡¨ç¤ºã€‚é€™å€‹å‡½å¼çš„å›å‚³å€¼æ˜¯å€‹ tupleï¼š(pid, fd)ï¼Œå­è¡Œç¨‹å¾—åˆ°çš„ pid æœƒæ˜¯ 0ï¼Œè€Œçˆ¶è¡Œç¨‹æœƒå¾—åˆ°ä¸€å€‹é 0 çš„å€¼ï¼Œç‚ºå­è¡Œç¨‹çš„ pidã€‚</blockquote>
<p>æ›å¥è©±èªªï¼Œæˆ‘å€‘å¯ä»¥å•Ÿå‹•ä¸€å€‹å­è¡Œç¨‹ï¼Œä¸¦ä½¿ç”¨çˆ¶è¡Œç¨‹ä¾†æ§åˆ¶è©²å­è¡Œç¨‹çš„çµ‚ç«¯è£ç½®ï¼Œä¹Ÿå°±æ˜¯ /dev/ttyã€‚åœ¨å¯¦åšä¹‹å‰ï¼Œå…ˆä¾†æ¸¬è©¦ä¸€ä¸‹ <tt class="docutils literal">pty.fork()</tt> ï¼š</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">pid</span><span class="p">,</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Child process</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Hello World!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;SIGINT Received!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parent wait for 1 sec then write 0x03...&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parent write 0x03&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x03</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Read until EOF or Input/Output Error</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">buf</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="n">buf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parent read from pty fd: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parent wait for child process {!r} to exit...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
    <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parent exit&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>åŸ·è¡Œä»¥ä¸Šç¨‹å¼ç¢¼å¾Œæ‡‰è©²æœƒå‡ºç¾ä»¥ä¸‹çµæœ (Ubuntu 16.04 with Python 3.5)ï¼š</p>
<div class="highlight"><pre><span></span>$ python3.5 pty_fork_test.py
Parent <span class="nb">wait</span> <span class="k">for</span> <span class="m">1</span> sec <span class="k">then</span> write 0x03...
Parent write 0x03
Parent <span class="nb">read</span> from pty fd: b<span class="s1">&#39;Hello World!\r\n^CSIGINT Received!\r\n&#39;</span>
Parent <span class="nb">wait</span> <span class="k">for</span> child process <span class="m">17676</span> to exit...
Parent <span class="nb">exit</span>
</pre></div>
<p>é€™æ®µç¨‹å¼ç¢¼å±•ç¤ºäº†çˆ¶è¡Œç¨‹å¦‚ä½•ä½¿ç”¨ <tt class="docutils literal">pty.fork()</tt>
å›å‚³çš„ file descriptor èˆ‡å­è¡Œç¨‹æºé€šçš„éç¨‹ï¼š</p>
<ol class="arabic simple">
<li>å­è¡Œç¨‹çš„ stdout é€£æ¥åˆ° slave ç«¯ï¼Œå› æ­¤å­è¡Œç¨‹å° stdout å¯«å…¥çš„å…§å®¹å¯ä»¥è¢«çˆ¶è¡Œç¨‹é€éè®€å– master ç«¯ï¼Œä¹Ÿå°±æ˜¯ <tt class="docutils literal">pty.fork()</tt> å›å‚³çš„ file descriptorï¼Œä¾†æ¥æ”¶ã€‚å› æ­¤ï¼Œçˆ¶è¡Œç¨‹èƒ½å¤ è®€å–åˆ°å­è¡Œç¨‹å° stdout å¯«å…¥çš„ <tt class="docutils literal">Hello <span class="pre">World!\n</span></tt> å­—ä¸²ã€‚</li>
<li>å­è¡Œç¨‹å¯«å…¥çš„ <tt class="docutils literal">Hello World\n</tt> åˆ°äº†çˆ¶è¡Œç¨‹è®Šæˆäº† <tt class="docutils literal">Hello World\r\n</tt> ï¼Œå¤šäº†ä¸€å€‹ <em>Carriage Return</em> <tt class="docutils literal">\r</tt> å­—å…ƒï¼Œé€™æ˜¯ Line discipline æ­£åœ¨ä½œç”¨çš„çµæœã€‚é€™è­‰æ˜äº†ä¸­é–“ä¸¦ä¸æ˜¯åªæœ‰å–®ç´”çš„è³‡æ–™äº¤æ›ï¼Œè€Œæ˜¯ Linux çš„ TTY ç³»çµ±åœ¨ä½œå‹•ä¸­ã€‚</li>
<li>çˆ¶è¡Œç¨‹å° file descriptor å¯«å…¥æ•¸å€¼ <tt class="docutils literal">0x03</tt> å¾Œï¼Œåˆ°äº†å­è¡Œç¨‹è®Šæˆäº† SIGINT ä¿¡è™Ÿè€Œè¢« Python æ•æ‰ç‚º <tt class="docutils literal">KeyboardInterrupt</tt> ä¾‹å¤–ï¼Œæ¥è‘—å­è¡Œç¨‹å° stdout å¯«å…¥ <tt class="docutils literal">SIGINT <span class="pre">Received!\n</span></tt> å­—ä¸²ï¼Œç„¶å¾Œè¢«çˆ¶è¡Œç¨‹è®€å–ä¸¦é¡¯ç¤ºç‚º <tt class="docutils literal">^CSIGINT <span class="pre">Received!\r\n</span></tt> ã€‚é€™ä¹Ÿè­‰æ˜äº† Line discipline ä»¥åŠ TTY ç³»çµ±çš„ä½œç”¨ã€‚</li>
</ol>
<p>ä»¥ä¸Šæ˜¯å° <tt class="docutils literal">pty.fork()</tt> åšçš„ç°¡å–®æ¸¬è©¦ã€‚æ¥ä¸‹ä¾†ä¾†å¯¦åšå•¦ï¼</p>
</div>
<div class="section" id="the-mp3-player-powered-by-madplay">
<h2>The MP3 player powered by madplay</h2>
<p>é‡å°ã€Œä½¿ç”¨ Python + madplay æ§åˆ¶ MP3 æª”æ¡ˆçš„æ’­æ”¾ã€é€™ä»¶äº‹ï¼Œå¯ä»¥é€™æ¨£åšï¼š</p>
<ol class="arabic simple">
<li>ä½¿ç”¨ <tt class="docutils literal">pty.fork()</tt> Fork å‡ºä¸€å€‹å­è¡Œç¨‹ï¼Œè®“è©²å­è¡Œç¨‹ä½¿ç”¨ Python çš„ <tt class="docutils literal">os.exec*</tt>
ç³»åˆ—å‡½å¼ä¾†å•Ÿå‹• madplay å–ä»£ç›®å‰è¡Œç¨‹ï¼Œä¸¦æ’­æ”¾ä¸€å€‹ MP3 æª”æ¡ˆã€‚</li>
<li>çˆ¶è¡Œç¨‹åˆ©ç”¨ <tt class="docutils literal">pty.fork()</tt> å–å¾—çš„ file descriptor ä¾†æ§åˆ¶å­è¡Œç¨‹çš„çµ‚ç«¯è£ç½®ï¼Œé€²è€Œæ§åˆ¶ madplayã€‚</li>
<li>æ²’äº‹å¾—æ¸…æ¸… file descriptor çš„ receive bufferï¼Œé¿å…è®“å­è¡Œç¨‹æŒçºŒå¯«å…¥è€Œå¡çˆ† bufferï¼ˆé€™æ˜¯æˆ‘è‡ªå·±æƒ³çš„ï¼Œå¯¦éš›ä¸Šå¯èƒ½ä¸ç”¨ï¼Œä½†è²·å€‹ä¿éšªå˜›ï¼‰ã€‚</li>
<li>å­è¡Œç¨‹çš„ madplay æ’­æ”¾å®Œç•¢å¾Œå¿…é ˆé€šçŸ¥çˆ¶è¡Œç¨‹ï¼Œé€™æ™‚çˆ¶è¡Œç¨‹å¿…é ˆä½¿ç”¨ <tt class="docutils literal">os.wait</tt> æˆ– <tt class="docutils literal">os.waitpid</tt> ä¾†æ”¶æ‹¾å­è¡Œç¨‹ï¼Œå¦å‰‡æœƒç”¢ç”Ÿå½Šå±è¡Œç¨‹ã€‚</li>
</ol>
<p>ä¸å›‰å—¦ï¼Œç›´æ¥ä¸Š codeï¼š</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base error&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ReadTimeout</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Polling timeout&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">PlayerState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The state of the player&quot;&quot;&quot;</span>
    <span class="n">PLAY</span> <span class="o">=</span> <span class="s1">&#39;play&#39;</span>
    <span class="n">PAUSE</span> <span class="o">=</span> <span class="s1">&#39;pause&#39;</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span>


<span class="k">class</span> <span class="nc">Mp3FilePlayer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">STOP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_start_play</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method forks a child process and start exec &#39;madplay&#39; to play</span>
<span class="sd">            the mp3 file. Since &#39;madplay&#39; can ONLY be controlled by tty, we have</span>
<span class="sd">            to use pty.fork and use the return fd in the parent process (which</span>
<span class="sd">            connects the child&#39;s controlling terminal) to control the playback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Register SIGCHLD to get notified when the child process terminated</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigchld_handler</span><span class="p">)</span>

        <span class="n">pid</span><span class="p">,</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Child process. Exec madplay</span>
            <span class="n">os</span><span class="o">.</span><span class="n">execl</span><span class="p">(</span><span class="s1">&#39;/usr/bin/madplay&#39;</span><span class="p">,</span> <span class="s1">&#39;--tty-control&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Parent process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span> <span class="o">=</span> <span class="n">fd</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Forked child TTY fd: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span> <span class="o">=</span> <span class="n">pid</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Forked child PID: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_tty</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_tty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the TTY fd by n bytes or raise ReadTimeout if reached specified timeout.</span>
<span class="sd">            The timeout value is in milliseconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span><span class="p">)</span>  <span class="c1"># Immediately after the polling</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadTimeout</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Number of polled events != 1&#39;</span>

        <span class="n">fd</span><span class="p">,</span> <span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Unexpected polled event: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_clear_tty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clearing the TTY fd. Preventing the receiving buffer to overflow.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Keep reading until timeout, which means nothing more to read.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_tty</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ReadTimeout</span><span class="p">:</span>
                <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_sigchld_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler function of SIGCHLD&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SIGCHLD signal received.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the playback or resume from pausing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">==</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">STOP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_play</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">PLAY</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">==</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">PAUSE</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_tty</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">PLAY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pause the playback&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">==</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">PLAY</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_tty_fd</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_tty</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">PAUSE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the playback. This will stop the child process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">!=</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">STOP</span><span class="p">:</span>
            <span class="c1"># Unregister the signal (set to SIG_DFL) to prevent recusively calling stop()</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Kill pid {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Wait pid {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Child process {} died.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_pid</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">player_state</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">.</span><span class="n">STOP</span>
</pre></div>
</td></tr></table><p>é€™æ®µç¨‹å¼ç¢¼å®šç¾©äº†é¡åˆ¥ <tt class="docutils literal">Mp3FilePlayer</tt> ä¾†æ§åˆ¶æ’­æ”¾ã€‚ä»¥ä¸‹æ˜¯å¹¾å€‹é‡é»ï¼š</p>
<ol class="arabic simple">
<li><tt class="docutils literal">Mp3FilePlayer</tt> å®šç¾©äº† <tt class="docutils literal">play</tt> ï¼Œ <tt class="docutils literal">pause</tt> åŠ <tt class="docutils literal">stop</tt>
é€™ä¸‰å€‹æ–¹æ³•ä¾†æ§åˆ¶ MP3 æª”æ¡ˆçš„æ’­æ”¾ã€æš«åœåŠåœæ­¢ã€‚</li>
<li><tt class="docutils literal">stop</tt> æ–¹æ³•æœƒè—‰ç”±é€å‡º SIGTERM ä¿¡è™Ÿä¾†åœæ‰å­è¡Œç¨‹ï¼Œä¸¦ä½¿ç”¨ <tt class="docutils literal">waitpid()</tt>
ä¾†æ”¶æ‹¾å–„å¾Œã€‚</li>
<li>ä½¿ç”¨ <tt class="docutils literal">select.poll()</tt> ï¼Œè€Œéç›´æ¥ä½¿ç”¨ <tt class="docutils literal">os.read()</tt>
ç›´æ¥è®€å– file descriptorã€‚åŸå› æ˜¯æˆ‘éœ€è¦å°è®€å–é€™ä»¶äº‹è¨­å®š timeoutï¼Œè€Œ <tt class="docutils literal">os.read()</tt> é€™å€‹å‡½å¼ç„¡æ³•åšåˆ°ã€‚</li>
<li>è¨­å®š <tt class="docutils literal">Mp3FilePlayer._sigchld_handler</tt> æ–¹æ³•ç•¶ SIGCHLD ä¿¡è™Ÿçš„è™•ç†å‡½å¼ï¼Œä»¥ä¾¿åœ¨ madplay æ’­æ”¾å®Œ MP3 æª”å¾Œï¼Œè®“çˆ¶è¡Œç¨‹å‘¼å« <tt class="docutils literal">stop</tt> æ–¹æ³•ä¾†æ”¶æ‹¾å­è¡Œç¨‹ï¼Œé¿å…ç”¢ç”Ÿå½Šå±è¡Œç¨‹ã€‚</li>
</ol>
<p><tt class="docutils literal">Mp3FilePlayer</tt> å¯ä»¥é€™æ¨£ä½¿ç”¨ï¼š</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">mp3_player</span> <span class="kn">import</span> <span class="n">Mp3FilePlayer</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Mp3FilePlayer</span><span class="p">(</span><span class="s1">&#39;/tmp/test.mp3&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
<span class="c1"># The music should be started. The play method return immediately.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
<span class="c1"># The music should be paused now. The pause method also return</span>
<span class="c1"># immediately.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
<span class="c1"># The playback should be resumed from where it was paused.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="c1"># The music should be stopped now.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
<span class="c1"># The music should be started from the beginning.</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>ç¶“éé€™å¹¾å¤©çš„ç ”ç©¶ç¸½ç®—ç¨å¾®ç†è§£äº† TTY é€™æ±è¥¿ï¼Œä¹Ÿç†è§£äº†å¦‚ä½•ä½¿ç”¨ Python çš„ pty æ¨¡çµ„ä¾†æ§åˆ¶å…¶ä»–è¡Œç¨‹çš„çµ‚ç«¯ã€‚å¸Œæœ›é€™ç¯‡æ–‡èƒ½å¹«åŠ©å¤§å®¶ğŸ‰</p>
</div>
<div class="section" id="references">
<h2>References</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.linusakesson.net/programming/tty/">The TTY demystified</a></li>
<li><a class="reference external" href="https://unix.stackexchange.com/q/117981">What are the responsibilities of each Pseudo-Terminal (PTY) component
(software, master side, slave side)?</a></li>
<li><a class="reference external" href="http://olvaffe.blogspot.tw/2009/01/console-io.html">ä¸€åƒé›¶ä¸€å¤œä¹‹ Console I/O</a></li>
<li><a class="reference external" href="http://zwai.pixnet.net/blog/post/24326951-linux-tty-driver---linux-tty-%E9%A9%85%E5%8B%95%E7%A8%8B%E5%BC%8F">Linux TTY Driverâ€Šâ€”â€ŠLinux TTY é©…å‹•ç¨‹å¼</a></li>
<li><a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/unix/TypingEOFEffects">What typing ^D really does on Unix</a></li>
<li><a class="reference external" href="http://www.wowotech.net/tty_framework/tty_concept.html">Linux TTY framework(1)_ åŸºæœ¬æ¦‚å¿µ</a></li>
<li><a class="reference external" href="http://www.wowotech.net/tty_framework/application_view.html">Linux TTY framework(3)_ ä»åº”ç”¨çš„è§’åº¦çœ‹ TTY è®¾å¤‡</a></li>
</ul>
</div>

            <div>
</div>

            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2018-04-11T00:00:00+08:00">Apr 11, 2018</time>
            <h4>Category</h4>
            <a class="category-link" href="https://johnliu55.tw/categories.html#python-ref">Python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://johnliu55.tw/tags#linux-ref">Linux
                    <span>1</span>
</a></li>
                <li><a href="https://johnliu55.tw/tags#python-ref">Python
                    <span>1</span>
</a></li>
                <li><a href="https://johnliu55.tw/tags#tty-ref">TTY
                    <span>1</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="https://github.com/johnliu55tw" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="https://www.linkedin.com/in/johnliu55tw/" title="My LinkedIn Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-linkedin sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="https://github.com/Pelican-Elegant/elegant/" title="Theme Elegant Home Page">Elegant</a></li>
    </ul>
</div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : MIT -->
</html>