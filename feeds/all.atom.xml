<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>John Engineering Stuff</title><link href="https://johnliu55.tw/" rel="alternate"></link><link href="https://johnliu55.tw/feeds/all.atom.xml" rel="self"></link><id>https://johnliu55.tw/</id><updated>2021-06-25T00:00:00+08:00</updated><entry><title>3D列印二三事</title><link href="https://johnliu55.tw/3d-printing-stuff.html" rel="alternate"></link><published>2021-06-25T00:00:00+08:00</published><updated>2021-06-25T00:00:00+08:00</updated><author><name>John Liu</name></author><id>tag:johnliu55.tw,2021-06-25:/3d-printing-stuff.html</id><summary type="html">&lt;p class="first last"&gt;關於我玩3D列印的事&lt;/p&gt;
</summary><content type="html">&lt;div class="admonition admonition-"&gt;
&lt;p class="first admonition-title"&gt;變更記錄&lt;/p&gt;
&lt;dl class="last docutils"&gt;
&lt;dt&gt;2020-06-27&lt;/dt&gt;
&lt;dd&gt;加入「 &lt;a class="reference external" href="https://octoprint.org/"&gt;OctoPrint&lt;/a&gt; 」&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;p&gt;這篇無關技術，單純想講一下我玩 3D 列印一年多來的故事呵呵。&lt;/p&gt;
&lt;p&gt;我一直都很喜歡 DIY、自己弄東弄西的感覺。唸大學的時候把 KTR 給大改成 Cafe Racer；租空房買了幾萬塊的 Ikea 傢俱全部自己組；選用 ArchLinux 把自己的 Linux 給拼湊起來。雖然很累，但我很享受這些過程。&lt;/p&gt;
&lt;p&gt;也忘了是為什麼，2019 年時我偶然得知了「3D 印表機」這個東西。這玩意兒太讚了吧！只要電腦畫的出來，我就可以把他變成實體，想到就好爽啊！&lt;/p&gt;
&lt;p&gt;所以在 2019 年底，我下定決心買了第一台 3D 印表機：
&lt;a class="reference external" href="https://www.anycubic.com/products/anycubic-i3-mega-s"&gt;Anycubic i3 Mega S&lt;/a&gt; 。&lt;/p&gt;
&lt;p&gt;靠著這台機器我理解了 3D 列印的概念，印了不少東西後秉持著 DIY 精神也改裝了不少東西上去，從加燈條、燒客製 Firmware、到自己設計 Direct Extruder，玩的不亦樂乎。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="Anycubic i3 Mega S 最終型態 " src="https://johnliu55.tw/3d-printing-stuff/images/anycubic_i3.jpg" style="width: 600px;" /&gt;
&lt;div class="legend"&gt;
Anycubic i3 Mega S 最終型態&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;到了 2020 年底，我發現大部分的時間我都是在「改進它」而不是「用它」，覺得這樣下去好像不太對勁，我應該花多點時間在 3D 列印本身。於是咧，趁著 Cyber Monday 免運活動訂了一台
&lt;a class="reference external" href="https://www.prusa3d.com/original-prusa-i3-mk3/"&gt;Prusa i3 MK3S+&lt;/a&gt; 。&lt;/p&gt;
&lt;p&gt;Prusa 是一間位於捷克的公司，他們的 Prusa i3 系列是一台需要自己從零件開始組裝，而且號稱同價格帶中列印品質最好的機器，但比起中國牌子的機器還是貴上不少（749 鎂不含運），所以當初猶豫超級久。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="Prusa i3 assembling" src="https://johnliu55.tw/3d-printing-stuff/images/prusa_assembling.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
Prusa i3 MK3S+ 組裝過程&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;組裝花了我兩天的時間，不過他開始印的時候真的超有成就感，印出來的品質也不是開玩笑，跟 Anycubic 真的有差。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="Prusa Benchy" src="https://johnliu55.tw/3d-printing-stuff/images/prusa_benchy.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
Prusa i3 MK3S+ 印出來的 Benchy&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;「你終究要開歐洲車的，那為什麼不一開始就開呢？」&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;欸，不過作為入門，Anycubic 還是相當稱職的，而且拆拆裝裝改來改去比較不會心痛。&lt;/p&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;線材防潮箱&lt;/h2&gt;
&lt;p&gt;既然升級了印表機，週邊也要跟著升級一下。&lt;/p&gt;
&lt;p&gt;Prusa i3 和 Anycubic i3 這個型式（FDM，其他還有 SLS、SLA 等）的 3D 印表機需要「線材」（Filament）當原料來印出成品， 而線材又有分不同的塑膠材質，像是 PLA、PETG、ABS 等等。而某些材質容易受潮，受潮後會造成印出成品品質變差，強度變低，甚至印到一半就失敗。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt=" 受潮後印出來的成品 " src="https://johnliu55.tw/3d-printing-stuff/images/wet_filament.jpg" style="width: 800px;" /&gt;
&lt;p class="caption"&gt;Source: &lt;a class="reference external" href="https://www.matterhackers.com/news/filament-and-water"&gt;MatterHacker&lt;/a&gt;&lt;/p&gt;
&lt;div class="legend"&gt;
乾燥和受潮線材印出成品比較，可以看到受潮線材的表面相當粗糙&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;其中一個解決方法是&lt;strong&gt;讓線材在使用前變乾燥&lt;/strong&gt;。我一開始是用這個方法，因為只要拿一台食物乾燥機來改裝一下就行了。甚至如果有溫控烤箱，使用之前拿線材低溫烘烤一下也可以，便宜又簡單。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY 線材乾燥機 " src="https://johnliu55.tw/3d-printing-stuff/images/diy_filament_dryer.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
DIY 線材乾燥機&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;不過每次使用前都要烘它個兩三小時，久了也是有點煩。所以之後決定採用另一個方法，&lt;strong&gt;讓線材由始至終都待在乾燥的環境中&lt;/strong&gt;，連受潮的機會都不讓它有。而關於這種東西，網路上有相當多的資源可以參考，來自已 DIY。這邊貼一個我很喜歡的頻道 &lt;strong&gt;CNC Kitchen&lt;/strong&gt; 實作線材防潮箱的影片：&lt;/p&gt;
&lt;div class="youtube youtube-16x9"&gt;&lt;iframe src="https://www.youtube.com/embed/WEFtUKGAd7k" width="800" height="450" allowfullscreen seamless frameBorder="0"&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;p&gt;這箱子的基本概念很簡單：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;找一個夠大的密封式防潮箱&lt;/li&gt;
&lt;li&gt;裡面加個支架放線材卷（Filament Spool）&lt;/li&gt;
&lt;li&gt;鑽幾個洞讓線材能出入&lt;/li&gt;
&lt;li&gt;把除濕劑倒進去，再放一台濕度計監控濕度&lt;/li&gt;
&lt;li&gt;蓋子蓋起來&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;聽起來很簡單嘛，所以我就做了一個：&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY Dry Box" src="https://johnliu55.tw/3d-printing-stuff/images/dry_box.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
我的 DIY 線材防潮箱&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;跟影片裡的比起來，我另外設計了&lt;strong&gt;外部線材架&lt;/strong&gt;。因為某些線材不易受潮，所以可以放在一般環境中也不會影響品質。所以我在箱蓋上另外設計了支架來放這些線材。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY Dry Box Top Rack" src="https://johnliu55.tw/3d-printing-stuff/images/dry_box_top_rack_3.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
外部線材架&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;放線材的桿子都是 8mm 的碳纖維棒，而且兩側都有軸承來讓它可以滑順的滾動。用碳纖維棒只是因為找不到同規格的金屬棒，絕對不是因為碳纖維比較潮。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY Dry Box Bearing Rod" src="https://johnliu55.tw/3d-printing-stuff/images/dry_box_bearing.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY Dry Box Top Rack Bearing" src="https://johnliu55.tw/3d-printing-stuff/images/dry_box_top_rack_2.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY Dry Box Inside Rack Bearing" src="https://johnliu55.tw/3d-printing-stuff/images/dry_box_inside_rack.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;p&gt;利用 PTFE Tube 加上我自己設計的支架讓線材能順利的走到印表機：&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt=" 線材走線支架 " src="https://johnliu55.tw/3d-printing-stuff/images/ptfe_rack.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
PTFE Tube + 支架&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;我設計了一個零件讓 PTFE Tube 可以固定在 Extruder 上：&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="PTFE Tube Cap" src="https://johnliu55.tw/3d-printing-stuff/images/ptfe_tube_cap.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
PTFE Tube Cap&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;設計這個零件很簡單，因為 Prusa i3 系列印表機是 open-sourced！所以可以直接拿到這個零件的 STL 檔進行修改。&lt;/p&gt;
&lt;p&gt;把箱子跟印表機組合在一起最後長這樣：&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="DIY Dry Box with Prusa i3" src="https://johnliu55.tw/3d-printing-stuff/images/dry_box_all.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
指揮艇組合&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;這東西好用到不行啊！&lt;/strong&gt;不但能保持線材乾燥，閒置的線材現在也有地方放了，不會滾來滾去的，超方便。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="octoprint"&gt;
&lt;h2&gt;OctoPrint&lt;/h2&gt;
&lt;p&gt;不管是 Anycubic i3 Mega S 或是 Prusa i3 MK3S+，要開始列印都有個繁雜的流程：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;把 SD 卡插到電腦上&lt;/li&gt;
&lt;li&gt;把 Slicer 產生出來的 &lt;tt class="docutils literal"&gt;.gcode&lt;/tt&gt; 檔從電腦放到 SD 卡上&lt;/li&gt;
&lt;li&gt;把 SD 卡從電腦拔出來，插到印表機上&lt;/li&gt;
&lt;li&gt;從印表機選擇 SD 卡上的檔案，開始列印&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="figure"&gt;
&lt;img alt="Prusa i3 SD card" src="https://johnliu55.tw/3d-printing-stuff/images/prusa_sdcard.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
Prusa i3 MK3S+ SD 卡列印介面&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;有些近期推出的 3D 印表機已經內建 WiFi 功能，換句話說就是能夠透過網路來傳輸
&lt;tt class="docutils literal"&gt;.gocde&lt;/tt&gt; 檔，不用再插插拔拔的了。而為了讓 Prusa i3 MK3S+ 能夠支援網路列印，我們可以透過
&lt;a class="reference external" href="https://octoprint.org/"&gt;OctoPrint&lt;/a&gt; 這個 open-source 專案來達成。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;a class="reference external image-reference" href="https://octoprint.org/"&gt;&lt;img alt="OctoPrint Logo" src="https://johnliu55.tw/3d-printing-stuff/images/octoprint_logo.png" style="width: 600px;" /&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;p&gt;OctoPrint 提供了一個 Web UI 讓使用者能夠遠端監控印表機目前的狀態，以及將 &lt;tt class="docutils literal"&gt;.gcode&lt;/tt&gt; 檔「串流」至印表機的功能。也就是這個「串流」功能，讓我們可以遠端列印，不用再透過 SD 卡了。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="OctoPrint UI" src="https://johnliu55.tw/3d-printing-stuff/images/octoprint_ui.png" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
OctoPrint Web UI&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;有了 OctoPrint 之後，列印流程變成了：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;把 Slicer 產生出來的 &lt;tt class="docutils literal"&gt;.gcode&lt;/tt&gt; 檔透過 Web UI 上傳至 OctoPrint&lt;/li&gt;
&lt;li&gt;從 OctoPrint Web UI 指示 3D 印表機開始列印這個 &lt;tt class="docutils literal"&gt;.gcode&lt;/tt&gt; 檔&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;同時我們也可以從 Web UI 上監控列印過程，舒服。&lt;/p&gt;
&lt;div class="section" id="octopi"&gt;
&lt;h3&gt;OctoPi&lt;/h3&gt;
&lt;p&gt;OctoPrint 是用 Python 寫的，並使用 USB 介面跟 3D 印表機溝通，所以基本上任何&lt;strong&gt;有 USB 且能跑 Python 的平台&lt;/strong&gt;都可以安裝 OctoPrint。不過大家最常用的還是 Raspberry Pi，因為便宜好取得，且 OctoPrint 官方也提供
&lt;a class="reference external" href="https://octoprint.org/download/"&gt;OctoPi&lt;/a&gt; 這個 image 可以直接將 OctoPrint
佈署至 Raspberry Pi 上。我原本是拿一塊閒置的 Beaglebone Black 來跑，但跑起來實在是相當慢…所以最後還是買了二手 Raspberry Pi 3B 來佈署。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="OctoPi" src="https://johnliu55.tw/3d-printing-stuff/images/octopi.jpg" style="width: 600px;" /&gt;
&lt;div class="legend"&gt;
Raspberry Pi 3B 與 Prusa i3 MK3S+&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;另外呢，OctoPrint 還有各式各樣的 Plugin 可以裝，像是
&lt;a class="reference external" href="https://github.com/OctoPrint/OctoPrint-FirmwareUpdater/blob/master/README.md"&gt;Firmware Updater&lt;/a&gt;
能夠遠端更新印表機 Firmware、
&lt;a class="reference external" href="https://github.com/jneilliii/OctoPrint-BedLevelVisualizer"&gt;Bed Visualizer&lt;/a&gt;
能夠看到 Bed Leveling 的狀態等，實在好用，建議有 3D 印表機但還沒裝 OctoPrint 的一定要試一下。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;印列成品&lt;/h2&gt;
&lt;p&gt;這邊放一些我自己設計的小東西。&lt;/p&gt;
&lt;div class="section" id="id5"&gt;
&lt;h3&gt;筆電立架&lt;/h3&gt;
&lt;p&gt;我的螢幕、鍵盤、滑鼠都是外接的，所以筆電其實沒有必要打開。為了節省空間，我想要把筆電立起來藏在螢幕後面，所以設計了一個立架來放。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt=" 筆電立架 " src="https://johnliu55.tw/3d-printing-stuff/images/laptop_rack.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt=" 筆電立架獨照 " src="https://johnliu55.tw/3d-printing-stuff/images/laptop_rack_detail.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
筆電立架&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="usb-hub"&gt;
&lt;h3&gt;USB Hub 支架&lt;/h3&gt;
&lt;p&gt;同樣是為省空間（房間是有多小）跟整線，我設計了一個 USB Hub 的支架，把我用的 USB Hub 固定在螢幕架上，讓整體更乾淨。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="USB Hub 支架 " src="https://johnliu55.tw/3d-printing-stuff/images/usb_hub_rack.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
USB Hub 支架&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="raspberry-pi-4-platform"&gt;
&lt;h3&gt;Raspberry Pi 4 Platform&lt;/h3&gt;
&lt;p&gt;自從 Raspberry Pi 4 有了 USB 3.0 後，外接 SSD 變成很合理的選擇，所以我設計了一個 SATA SSD Mount 把 Raspberry Pi 跟 SSD 結合在一起。另外為了實驗需求也設計了一個支架來裝些按鈕跟 LED。&lt;/p&gt;
&lt;p&gt;這邊要提一下 Raspberry Pi 本體的 Case 並不是我設計的，而是 Thingiverse 上找的：
&lt;a class="reference external" href="https://www.thingiverse.com/thing:3726254"&gt;Raspberry Pi 4 snap fit case with 30mm Fan&lt;/a&gt;
。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="Raspberry Pi 4 Mount" src="https://johnliu55.tw/3d-printing-stuff/images/rpi4_mount.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
Raspberry Pi 4 Mount（請忽略上面的灰塵）&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h3&gt;可調式電源供應器&lt;/h3&gt;
&lt;p&gt;自己有時候會玩一些微控制器等等的東西，這時候就需要一台可調式電源供應器（Bench Power Supply）啦。買了一些 DIY 零件後自己設計個外殼把它們裝起來。&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="Bench Power Supply Front" src="https://johnliu55.tw/3d-printing-stuff/images/bench-power-supply/front.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="Bench Power Supply Back" src="https://johnliu55.tw/3d-printing-stuff/images/bench-power-supply/back.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="Bench Power Supply Inside" src="https://johnliu55.tw/3d-printing-stuff/images/bench-power-supply/inside.jpg" style="width: 800px;" /&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="Bench Power Supply Power On" src="https://johnliu55.tw/3d-printing-stuff/images/bench-power-supply/on.jpg" style="width: 800px;" /&gt;
&lt;div class="legend"&gt;
DIY Bench Power Supply（請忽略要印超久懶得再印一次所以顏色不太搭的上蓋）&lt;/div&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;p&gt;我還記得剛拿到第一台印表機時，我常常可以盯著列印過程幾十分鐘沒問題，看到自己設計的東西一小步一小步被印出來的感動之情難以言語啊！尤其印完之後拿在手上的感覺，真的是滿足到不行。&lt;/p&gt;
&lt;p&gt;先分享到這裡，有興趣我再多寫一點。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="3D Printing"></category><category term="3D Printing"></category></entry><entry><title>為何需要 Async/await 語法？</title><link href="https://johnliu55.tw/async-await-why.html" rel="alternate"></link><published>2020-06-14T00:00:00+08:00</published><updated>2020-06-14T00:00:00+08:00</updated><author><name>John Liu</name></author><id>tag:johnliu55.tw,2020-06-14:/async-await-why.html</id><summary type="html">&lt;p class="first last"&gt;在非同步程式設計（Asynchronous Programming）的領域裡，
為何需要要 Async/await 語法？&lt;/p&gt;
</summary><content type="html">&lt;p&gt;近年來有許多語言都加入了 &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Async/await"&gt;Async/await&lt;/a&gt; 這個語法來幫助開發者撰寫非同步程式碼，其中不乏像 JavaScript 與 Python 等熱門語言，和 &lt;a class="reference external" href="https://blog.rust-lang.org/2019/11/07/Async-await-stable.html"&gt;Rust&lt;/a&gt;
這樣的靜態形別語言。這邊就記錄一下我自己對它的看法。&lt;/p&gt;
&lt;div class="section" id="tl-dr"&gt;
&lt;h2&gt;TL;DR&lt;/h2&gt;
&lt;p&gt;我認為，使用 async 與 await 來寫非同步的程式碼，最大的好處在於你可以用&lt;strong&gt;同步程式設計的程式碼架構來實作非同步的邏輯&lt;/strong&gt;。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="http"&gt;
&lt;h2&gt;三個 HTTP 請求與他們的回呼&lt;/h2&gt;
&lt;p&gt;譬如，今天你想使用某個部落格的 API 來取得&lt;strong&gt;某個作者&lt;/strong&gt;寫的&lt;strong&gt;最新文章&lt;/strong&gt;上的&lt;strong&gt;最新評論&lt;/strong&gt;，然後拿它來做某件事。以同步的架構來寫的話，你可能會這樣子發送 HTTP 請求：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;doStuff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;syncHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/users/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;post&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;syncHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/posts/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;posts&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;syncHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/comments/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;post&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;comments&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;doSomethingToComment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;comment&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;setGetCommentError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;這是個很常見的模式：&lt;strong&gt;需要使用上一個請求所得到的回覆來發送下一個&lt;/strong&gt;。以同步的程式碼來實作的話：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;邏輯簡單明瞭，一眼就可以看出做了哪些事&lt;/li&gt;
&lt;li&gt;可以直接利用語言本身的錯誤處理機制（try-catch）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;不過在單執行緒的情況下，同步設計最大問題在於每一個 &lt;tt class="docutils literal"&gt;syncHttpGet&lt;/tt&gt;
都是以 Blocking 的方式在執行，所以在得到回覆之前是不會釋放該執行緒的。以前端來說，這會造成&lt;strong&gt;整個 UI 會被凍結，完全無法處理使用者的其他操作&lt;/strong&gt;。於是乎，前端或是 UI 相關的東西基本都採用非同步程式設計（Asynchronous Programming）來實作。&lt;/p&gt;
&lt;p&gt;還記得我第一次接觸到非同步程式設計，最難就難在理解&lt;strong&gt;非同步函式不會直接把結果 Return 給你&lt;/strong&gt;這件事。啊這樣我是要怎樣拿到結果啦，我下一個請求要怎麼發？&lt;/p&gt;
&lt;img alt="It's hard man" src="https://johnliu55.tw/async-await-why/images/oh-come-on.gif" /&gt;
&lt;p&gt;要解決這問題有幾種方法，不過在 JavaScript 的世界裡，這些非同步操作通常都會以&lt;strong&gt;接收函式為引數的函式&lt;/strong&gt;來實作，把最後得到的結果直接丟給你所指定的函式。這樣一來就算不 Return 值回去，也可以繼續下個動作。&lt;/p&gt;
&lt;p&gt;這個被傳進去的函式就稱為「回呼函式」（Callback Function）。用這個概念來實做同樣的邏輯大概會長這樣：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;doStuff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;callbackHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/users/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;statusCode&lt;/span&gt; &lt;span class="o"&gt;===&lt;/span&gt; &lt;span class="mf"&gt;200&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;callbackHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/posts/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;posts&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;statusCode&lt;/span&gt; &lt;span class="o"&gt;===&lt;/span&gt; &lt;span class="mf"&gt;200&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                    &lt;span class="nx"&gt;callbackHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/comments/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;comments&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;statusCode&lt;/span&gt; &lt;span class="o"&gt;===&lt;/span&gt; &lt;span class="mf"&gt;200&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                            &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
                            &lt;span class="nx"&gt;doSomethingToComment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;comment&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
                        &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                            &lt;span class="nx"&gt;setGetCommentError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Cannot get comment detail&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
                        &lt;span class="p"&gt;}&lt;/span&gt;
                    &lt;span class="p"&gt;})&lt;/span&gt;
                &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                    &lt;span class="nx"&gt;setGetCommentError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Cannot get post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
                &lt;span class="p"&gt;}&lt;/span&gt;
            &lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;setGetCommentError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Cannot get user&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;對，這就是回呼地獄（Callback Hell）&lt;/strong&gt;。因為必須在得到回覆後&lt;strong&gt;用裡面的資料再次進行非同步操作&lt;/strong&gt;，於是就出現了在回呼中再次使用回呼的模式。對，它會動，但很傷眼…&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;層層套疊的金字塔狀程式碼，很難一眼看出內部邏輯&lt;/li&gt;
&lt;li&gt;不斷重覆出現的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;if..else&lt;/span&gt;&lt;/tt&gt; 錯誤處理邏輯。另外，如果我只在乎最後的
&lt;tt class="docutils literal"&gt;comment&lt;/tt&gt; ，中間的每個 &lt;tt class="docutils literal"&gt;setGetCommentError&lt;/tt&gt; 都是多餘的程式碼。&lt;/li&gt;
&lt;/ol&gt;
&lt;img alt="Callback Hell meme" src="https://johnliu55.tw/async-await-why/images/callback_hell.jpg" /&gt;
&lt;p&gt;相信很多人都深受其害，迷失在這個地獄…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="it-will-be-fun-i-promise"&gt;
&lt;h2&gt;It Will Be Fun, I Promise&lt;/h2&gt;
&lt;p&gt;你的聲音， &lt;a class="reference external" href="https://en.wikipedia.org/wiki/ECMAScript#6th_Edition_%E2%80%93_ECMAScript_2015"&gt;ES6&lt;/a&gt; 聽到了，於是就出現了 &lt;a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"&gt;Promise&lt;/a&gt; 這個結構來擺脫回呼地獄，讓你可以用 &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Method_chaining"&gt;Method chaining&lt;/a&gt; 的方式來串連這些 HTTP 請求，而不是一層包一層的模式：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;doStuff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;asyncPromiseGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/users/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;asyncPromiseGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/posts/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;posts&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;asyncPromiseGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/comments/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;comments&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;data&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="nx"&gt;doSomethingToComment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;comment&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="k"&gt;catch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;setGetCommentError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;asyncPromiseGet&lt;/tt&gt; 函式會回傳一個 Promise 物件，上面有一個 &lt;tt class="docutils literal"&gt;then()&lt;/tt&gt; 方法接收一個回呼函式為引數，並在得到 HTTP 回覆時呼叫這個函式。同時 &lt;tt class="docutils literal"&gt;then()&lt;/tt&gt; 方法也會&lt;strong&gt;回傳一個新的
Promise 物件&lt;/strong&gt;，讓你可以一直 &lt;tt class="docutils literal"&gt;.then()&lt;/tt&gt; 下去。&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;註釋&lt;/p&gt;
&lt;p class="last"&gt;其實 &lt;tt class="docutils literal"&gt;then()&lt;/tt&gt; 方法可以接收兩個函式引數，這邊為了簡單起見只說明傳一個的情況，細節請看 &lt;a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises"&gt;Using Promises&lt;/a&gt;。&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Promise 真正厲害的地方在於，如果你給 &lt;tt class="docutils literal"&gt;then()&lt;/tt&gt; 的回呼函式也回傳了 Promise 物件，那麼這個 Promise 最後得到的值，&lt;strong&gt;會被送到&lt;/strong&gt; &lt;tt class="docutils literal"&gt;then()&lt;/tt&gt;
&lt;strong&gt;所回傳的那個新的 Promise 上&lt;/strong&gt;，讓下一個串起來的 &lt;tt class="docutils literal"&gt;then()&lt;/tt&gt;
能夠取得你的回呼函式想要得到的結果。就是因為這個原因，我們才能夠使用 Method chaining 而不是巢狀的方式來串連這些 HTTP
請求。&lt;/p&gt;
&lt;img alt="It will be fun, I promise!" src="https://johnliu55.tw/async-await-why/images/it-will-be-fun-i-promise.jpg" /&gt;
&lt;p&gt;Promise 讓金字塔消失了，而且也簡化了錯誤處理的機制，可以看到我只要最後加個
&lt;tt class="docutils literal"&gt;.catch()&lt;/tt&gt; 就能夠統一處理錯誤。然而，這還是逃不了回呼的概念，與同步版本相較之下還是沒那麼優雅。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;媽，可以不要回呼嗎？&lt;/h2&gt;
&lt;p&gt;就在我以為這輩子就這樣子了的時候， &lt;a class="reference external" href="https://en.wikipedia.org/wiki/ECMAScript#8th_Edition_%E2%80%93_ECMAScript_2017"&gt;ES8&lt;/a&gt; 出現了 async 與 await：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;doStuff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="nx"&gt;asyncHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/users/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;post&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="nx"&gt;asyncHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/posts/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;user&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;posts&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="kd"&gt;let&lt;/span&gt; &lt;span class="nx"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="nx"&gt;asyncHttpGet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/api/comments/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;post&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;comments&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;id&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;doSomethingToComment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;comment&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;setGetCommentError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到，除了出現 &lt;tt class="docutils literal"&gt;await&lt;/tt&gt; 跟 &lt;tt class="docutils literal"&gt;async&lt;/tt&gt; 這幾個字以外，基本上程式碼的架構與同步版的一模模一樣樣，也可以用語言原生的 &lt;tt class="docutils literal"&gt;try catch&lt;/tt&gt; 機制來進行錯誤處理，超讚的啦！&lt;/p&gt;
&lt;img alt="It's breathtacking!" src="https://johnliu55.tw/async-await-why/images/breathtaking.gif" /&gt;
&lt;p&gt;值得注意的是，async/await 看起來是全新的概念， 但其實這兩個語法是&lt;a class="reference external" href="https://stackoverflow.com/questions/46908575/async-await-native-implementations"&gt;由 Promise 和生成器（Generator）&lt;/a&gt;
來實作的。你可以試著在 Node.js 裡定義一個 async 函式並直接呼叫它：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;f&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="kc"&gt;undefined&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nx"&gt;f&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="nb"&gt;Promise&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="mf"&gt;1&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到 async 函式回傳的其實是 Promise。對背後實作有興趣可以去 Google 一下，或是去翻一下&lt;a class="reference external" href="https://www.tenlong.com.tw/products/9789864342525"&gt;忍者：JavaScript 開發技巧探秘 第二版&lt;/a&gt;這本書的第六章，裡面有很詳細的解釋。&lt;/p&gt;
&lt;p&gt;這篇就寫到這…下一篇可能會來聊聊 Python 的 &lt;tt class="docutils literal"&gt;asyncio&lt;/tt&gt; 吧…？&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="references"&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.tenlong.com.tw/products/9789864342525"&gt;忍者：JavaScript 開發技巧探秘 第二版&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises"&gt;Using Promises&lt;/a&gt; - MDN&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Async/await"&gt;Async/Await&lt;/a&gt; - JAVASCRIPT.INFO&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="Programming Language"></category><category term="Asynchronous Programming"></category><category term="JavaScript"></category><category term="Async/await"></category><category term="閒聊"></category></entry><entry><title>SSH Tunneling (Port Forwarding) 詳解</title><link href="https://johnliu55.tw/ssh-tunnel.html" rel="alternate"></link><published>2020-05-21T00:00:00+08:00</published><updated>2020-05-25T00:00:00+08:00</updated><author><name>John Liu</name></author><id>tag:johnliu55.tw,2020-05-21:/ssh-tunnel.html</id><summary type="html">&lt;p class="first last"&gt;詳細解釋使用SSH的Local Port Forwarding、Remote Port Forwarding、
和Dynamic Port Forwarding來建立加密通道（Tunneling）的方法。&lt;/p&gt;
</summary><content type="html">&lt;div class="admonition admonition-"&gt;
&lt;p class="first admonition-title"&gt;變更記錄&lt;/p&gt;
&lt;dl class="last docutils"&gt;
&lt;dt&gt;2020-05-25&lt;/dt&gt;
&lt;dd&gt;加入「&lt;a class="reference internal" href="#id10"&gt;補充：小技巧和工具&lt;/a&gt;」章節來放各種 SSH Tunneling 的小技巧和工具。&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;p&gt;前陣子研究了一下用 SSH Tunneling 來連到內部網路的方法，一開始實在有點難理解 SSH 指令與實際情況的關係，但了解後才發現他超級強大，於是就把細節記錄下來之後可以參考，也希望能幫大家了解一下這東西。&lt;/p&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;什麼是 SSH Tunneling (Port Forwarding)？&lt;/h2&gt;
&lt;p&gt;Tunneling 指的是將網路上的 A、B 兩個端點用某種方式連接起來，形成一個「隧道」，讓兩端的通訊能夠穿透某些限制（例如防火牆），或是能將通訊內容加密避免洩漏。而 SSH Tunneling 就是指利用 SSH 協定來建立這個隧道，所以不但能加密你的通訊，如果中間設有防火牆擋掉某些特定 Port 的連線（例如 HTTP/HTTPS 的 80/443）而沒有擋下 SSH 的 Port 22，這個隧道便會讓防火牆認為是只是一般的 SSH 連線，進而放行，也就達到了「穿透防火牆」的效果。&lt;/p&gt;
&lt;p&gt;另外，因為 SSH Tunneling 的目標是兩個端點上的 Port，而過程就像是把對 A 點上的某個 Port X 所傳送的資料&lt;strong&gt;轉送&lt;/strong&gt;
（Forward）至 B 點上的 Port Y，所以 SSH Tunneling 又稱為 &lt;strong&gt;SSH Port Forwarding&lt;/strong&gt; 。&lt;/p&gt;
&lt;img alt="Tunneling 示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/tunneling.png" /&gt;
&lt;p&gt;SSH Port Forwarding 有下列三種模式：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Local Port Forwarding&lt;/li&gt;
&lt;li&gt;Remote Port Forwarding&lt;/li&gt;
&lt;li&gt;Dynamic Port Forwarding&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;接下來會一一說明各種模式。先來看看在 SSH Port Forwarding 當中參與的角色有哪些。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="port-fowarding"&gt;
&lt;h2&gt;Port Fowarding 裡的角色定義&lt;/h2&gt;
&lt;p&gt;對 Local 和 Remote Port Forwarding 來說，都會有下面這三個角色：&lt;/p&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Client&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;任何你可以敲 &lt;tt class="docutils literal"&gt;ssh&lt;/tt&gt; 指令來啟動 Port Forwarding 的機器&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;SSH Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;可以被 &lt;strong&gt;Client&lt;/strong&gt; 用 SSH 連進去的機器&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;Target Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;某一台你想建立連線的機器，通常是為了對外開放這台機器上的服務&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;注意&lt;/strong&gt;， &lt;strong&gt;Client&lt;/strong&gt; 與 &lt;strong&gt;SSH Server&lt;/strong&gt; 本身都可以是 &lt;strong&gt;Target Server&lt;/strong&gt; ，不是真的要有三台機器才可以進行 Port Forwarding！&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;而 Dynamic Port Forwarding 比較不一樣，在於 Target Server 不會只有一台，而是可以被動態決定的。&lt;/p&gt;
&lt;p&gt;了解了這三個角色，那就先來看看 Local Port Forwarding 是怎麼回事。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="local-port-forwarding"&gt;
&lt;h2&gt;Local Port Forwarding&lt;/h2&gt;
&lt;div class="section" id="id2"&gt;
&lt;h3&gt;指令語法&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L [bind_address:]&amp;lt;port&amp;gt;:&amp;lt;host&amp;gt;:&amp;lt;host_port&amp;gt; &amp;lt;SSH Server&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 &lt;strong&gt;Client&lt;/strong&gt; 上開啟 &lt;tt class="docutils literal"&gt;bind_address:port&lt;/tt&gt; 等待連線，當有人連上時，將所有資料轉送到 &lt;tt class="docutils literal"&gt;host:host_port&lt;/tt&gt; 去。
&lt;strong&gt;注意&lt;/strong&gt;， &lt;tt class="docutils literal"&gt;host&lt;/tt&gt; 是相對於 &lt;strong&gt;SSH Server&lt;/strong&gt; 的位址，而不是 &lt;strong&gt;Client&lt;/strong&gt; ！&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h3&gt;使用情境一：連到位在防火牆後的開發伺服器上的服務&lt;/h3&gt;
&lt;p&gt;你有一台位於防火牆後的開發伺服器， 你在上面架了某個服務在 Port 8080 上，但防火牆只開放 Port 22 的 SSH 連線，讓你無法從你的電腦直接連到 Port 8080，但你又很想連到他…&lt;/p&gt;
&lt;img alt=" 情境 1 示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/local_scenario1_problem.png" /&gt;
&lt;p&gt;這時候只要你能夠 SSH 到那台伺服器，就可以利用 Local Port Forwarding 來開啟你電腦上的某個 Port（假設為 9090），將對它發送的資料轉送到伺服器的 Port 8080。這樣一來， 連上你的電腦的 Port 9090 就等於連上了防火牆後的伺服器的 Port 8080 ，也就繞過了防火牆的限制。&lt;/p&gt;
&lt;img alt=" 情境 1 解法示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/local_scenario1_solved.png" /&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Client&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;你的電腦&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;SSH Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;防火牆後的伺服器&lt;/li&gt;
&lt;li&gt;SSH Destination： &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;johnliu&amp;#64;my-server&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;Target Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;防火牆後的伺服器&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;SSH 指令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L 9090:localhost:8080 johnliu@my-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;這邊的 &lt;tt class="docutils literal"&gt;localhost&lt;/tt&gt; 是相對於 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;johnliu&amp;#64;my-server&lt;/span&gt;&lt;/tt&gt; ，指的就是防火牆後的伺服器本身。&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;註釋&lt;/p&gt;
&lt;ul class="last"&gt;
&lt;li&gt;&lt;p class="first"&gt;你完全可以在你的電腦上用相同的 Port number 來做 Port Forwarding，這邊用 &lt;tt class="docutils literal"&gt;9090&lt;/tt&gt; 只是為了避免混淆：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L 8080:localhost:8080 johnliu@my-server
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;如果你沒有給 &lt;tt class="docutils literal"&gt;bind_address&lt;/tt&gt; ，預設會 Bind 在 &lt;tt class="docutils literal"&gt;localhost&lt;/tt&gt; 上。如果你想把 Port &lt;tt class="docutils literal"&gt;9090&lt;/tt&gt; 開放給所有人用：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L 0.0.0.0:9090:localhost:8080 johnliu@my-server
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h3&gt;使用情境二：透過防火牆後的機器，連到防火牆後的特定服務&lt;/h3&gt;
&lt;p&gt;情境一有用的前提是&lt;strong&gt;你能夠 SSH 到提供服務的伺服器裡&lt;/strong&gt;，但今天如果你沒有權限，無法 SSH 進到提供服務的伺服器，那該怎麼辦呢？&lt;/p&gt;
&lt;img alt=" 情境 1 示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/local_scenario2_problem.png" /&gt;
&lt;p&gt;沒問題！只要你在防火牆後有任何一台你可以 SSH 的機器，接著修改一下指令裡的 &lt;tt class="docutils literal"&gt;host&lt;/tt&gt; 設定，你就可以利用這台機器進行資料轉送：&lt;/p&gt;
&lt;img alt=" 情境 1 解法示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/local_scenario2_solved.png" /&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Client&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;你的電腦&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;SSH Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;防火牆後你的機器&lt;/li&gt;
&lt;li&gt;SSH Destination： &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;johnliu&amp;#64;my-server&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;Target Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;防火牆後的伺服器&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;192.168.1.101:8080&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;SSH 指令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -L 9090:192.168.1.101:8080 johnliu@my-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;這邊的 &lt;tt class="docutils literal"&gt;192.168.1.101&lt;/tt&gt; 是相對於 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;johnliu&amp;#64;my-server&lt;/span&gt;&lt;/tt&gt; ，所以是防火牆後的伺服器的 IP 位址。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="remote-port-forwarding"&gt;
&lt;h2&gt;Remote Port Forwarding&lt;/h2&gt;
&lt;div class="section" id="id5"&gt;
&lt;h3&gt;指令語法&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -R [bind_address:]&amp;lt;port&amp;gt;:&amp;lt;host&amp;gt;:&amp;lt;host_port&amp;gt; &amp;lt;SSH Server&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 &lt;strong&gt;SSH Server&lt;/strong&gt; 上開啟 &lt;tt class="docutils literal"&gt;bind_address:port&lt;/tt&gt; 等待連線，當有人連上時，將所有資料轉送到 &lt;tt class="docutils literal"&gt;host:host_port&lt;/tt&gt; 去。
&lt;strong&gt;注意&lt;/strong&gt;， &lt;tt class="docutils literal"&gt;host&lt;/tt&gt; 是相對於 &lt;strong&gt;Client&lt;/strong&gt; 的位址，而不是 &lt;strong&gt;SSH Server&lt;/strong&gt; ！&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h3&gt;使用情境一：透過對外機器，讓其他人能夠連到你的電腦上的服務&lt;/h3&gt;
&lt;p&gt;你在你的電腦上開發完了一個服務架在 Port 8080 上，然後你想要 Demo 給客戶看，但你的電腦只有內部 IP，所以無法讓客戶連進來：&lt;/p&gt;
&lt;img alt="Remote 情境 1 示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/remote_scenario1_problem.png" /&gt;
&lt;p&gt;這時候只要利用 SSH Remote Forwarding，就可以藉由一台有 Internet IP 的對外機器，開啟上面的某個 Port（假設為 9090）來轉送資料到你的電腦上的 Port 8080。這樣子，客戶只要連上對外機器的 Port 9090 就等於是連上了你電腦的 Port 8080。&lt;/p&gt;
&lt;img alt="Remote 情境 1 解法示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/remote_scenario1_solved.png" /&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Client&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;你的電腦&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;SSH Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;對外機器&lt;/li&gt;
&lt;li&gt;SSH Destination： &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;johnliu&amp;#64;external-server&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;Target Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;你的電腦&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;SSH 指令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -R 0.0.0.0:9090:localhost:8080 johnliu@external-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;這邊的 &lt;tt class="docutils literal"&gt;localhost&lt;/tt&gt; 是相對於 &lt;strong&gt;Client&lt;/strong&gt;  ，指的就是你的電腦本身。&lt;/p&gt;
&lt;div class="admonition warning"&gt;
&lt;p class="first admonition-title"&gt;警告&lt;/p&gt;
&lt;p&gt;基於安全考量，
&lt;strong&gt;Remote Forwarding 預設都只能夠 bind 在 SSH Server 的 localhost 上&lt;/strong&gt;，所以單靠以上指令是無法讓 Port 9090 開放給外部連線的。你必須調整 SSH Server 上的 SSH 服務的設定檔（一般在 &lt;tt class="docutils literal"&gt;/etc/ssh/sshd_config&lt;/tt&gt; ）加入 &lt;tt class="docutils literal"&gt;GatewayPorts&lt;/tt&gt; 設定，才能讓所有人都連到：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;GatewayPorts yes
&lt;/pre&gt;&lt;/div&gt;
&lt;p class="last"&gt;這邊有三個選項：預設為 &lt;tt class="docutils literal"&gt;no&lt;/tt&gt; ，也就是唯一指定 localhost；設定為 &lt;tt class="docutils literal"&gt;yes&lt;/tt&gt; 可以唯一指定為 wildcard（ &lt;tt class="docutils literal"&gt;0.0.0.0&lt;/tt&gt; ）；設定為 &lt;tt class="docutils literal"&gt;clientspecified&lt;/tt&gt; 可以讓啟動 Remote Forwarding 的 Client 自行指定。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h3&gt;使用情境二：透過對外機器，從外面連回內部網路上的服務&lt;/h3&gt;
&lt;p&gt;有一個在內網裡的內部服務，你的電腦可以用 IP &lt;tt class="docutils literal"&gt;192.168.1.100&lt;/tt&gt;
和 Port 8080 連到這個服務，但因為都在內網所以大家都沒有 Internet IP，所以無法讓你從家裡透過 Internet 連回來：&lt;/p&gt;
&lt;img alt="Remote 情境 2 示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/remote_scenario2_problem.png" /&gt;
&lt;p&gt;這時候藉由 Remote Forwarding 和一台對外機器， 可以讓你從任何地方連回這個服務：&lt;/p&gt;
&lt;img alt="Remote 情境 2 解法示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/remote_scenario2_solved.png" /&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Client&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;你的電腦&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;SSH Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;對外機器&lt;/li&gt;
&lt;li&gt;SSH Destination： &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;johnliu&amp;#64;external-server&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;Target Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;內部服務&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;192.168.1.100:8080&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;SSH 指令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -R 0.0.0.0:9090:192.168.1.100:8080 johnliu@external-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在這裡， &lt;tt class="docutils literal"&gt;192.168.1.100&lt;/tt&gt; 是相對於你的電腦，所以就算外部機器連不到這個位址也沒關係，因為是透過你的電腦做資料轉送。這樣子，只要連到對外機器上的 Port 9090 就等於是連到內部服務上的 Port 8080 了，你就能夠從外部存取內網服務。&lt;/p&gt;
&lt;p&gt;這應該是 SSH Port Forwarding 最強大的功能了！只要在網路上租一台最便宜的主機（Linode, Digital Ocean 之類的），就可以拿他來當圖示中的對外機器，來連回內部網路上的服務。不過前提是你得在有內網連線時將 Port Forwarding 設定好，如果你到家後才想到，那就請你再跑一趟吧…&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="dynamic-port-forwarding"&gt;
&lt;h2&gt;Dynamic Port Forwarding&lt;/h2&gt;
&lt;div class="section" id="id8"&gt;
&lt;h3&gt;指令語法&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -D [bind_address:]&amp;lt;port&amp;gt; &amp;lt;SSH Server&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 SSH Server 上啟動一個 &lt;a class="reference external" href="https://zh.wikipedia.org/wiki/SOCKS"&gt;SOCKS&lt;/a&gt; 代理伺服器，同時在 &lt;strong&gt;Client&lt;/strong&gt; 上開啟 &lt;tt class="docutils literal"&gt;bind_address:port&lt;/tt&gt; 等待連線，當有人連上時，將所有資料轉送到這個 SOCKS 代理伺服器上，啟動相對應的連線請求。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="httphttp-s"&gt;
&lt;h3&gt;使用情境：建立一個 HTTP 代理伺服器連到內網的所有 HTTP(S) 服務&lt;/h3&gt;
&lt;p&gt;只要有一台位於內網且&lt;strong&gt;具有外部 IP&lt;/strong&gt; 的機器，你就可以利用這個方法建立一個 HTTP 代理伺服器，讓你能夠從外面連回內網裡的所有 HTTP(S) 服務：&lt;/p&gt;
&lt;img alt="Dynamic 情境示意圖 " src="https://johnliu55.tw/ssh-tunnel/images/dynamic.png" /&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;Client&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;你的電腦&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;SSH Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;內網裡具有外部 IP 的機器&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;Target Server&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="first last simple"&gt;
&lt;li&gt;N/A&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;SSH 指令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -D 9090 johnliu@internal-machine
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;假設你是用 Linux 和 Chrome，你可以在你的電腦上用以下指令讓 Chrome 使用這個代理伺服器：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;google-chrome --user-data-dir=~/proxied-chrome --proxy-server=socks5://localhost:9090
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;註釋&lt;/p&gt;
&lt;ul class="last simple"&gt;
&lt;li&gt;這邊的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;google-chrome&lt;/span&gt;&lt;/tt&gt; 只是範例，不同的 Linux 發行版名字可能會不同&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--user-data-dir&lt;/span&gt;&lt;/tt&gt; 是為了讓 Chrome 能夠開啟一個新的 Chrome session，不加的話 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--proxy-server&lt;/span&gt;&lt;/tt&gt; 這個設定就沒用了&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;一般的 Port Forwarding 只能夠轉送&lt;strong&gt;一個 IP 上的一個 Port&lt;/strong&gt; ，當你有很多 IP 或很多 Port 想轉時就只能一個一個開， 很不方便。相比之下，Dynamic Port Forwarding 能直接架起一個代理伺服器，只要你用的程式有支援 SOCKS 協定，透過這個代理伺服器讓你想怎麼轉就怎麼轉。不過這方式也不是沒缺點，就是那台轉送用的機器一定得要有對外 IP，這樣才能夠從你的電腦連回來。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id9"&gt;
&lt;h2&gt;結論&lt;/h2&gt;
&lt;p&gt;從圖可以看出來，Local 跟 Remote Forwarding 的差異主要在 &lt;strong&gt;Port 開啟的地方&lt;/strong&gt;：Local Forwarding 是將 Client 上的 Port 打開以供連線；Remote Forwarding 則是將 SSH Server 上的 Port 打開。另外要注意的點是轉送的目的地 &lt;tt class="docutils literal"&gt;host&lt;/tt&gt; ：Local Forwarding 是相對於 SSH Server，而 Remote Forwarding 則是相對於 Client。&lt;/p&gt;
&lt;p&gt;雖然 Dynamic Port Forwarding 的彈性更大，但條件就是 SSH Server 就必須要能夠從外面連回來。不過其實也是有 Workaround 啦，搭配一下 Port Forwarding 就行了，但這樣的話你有更好的 Proxy 選擇，像是 &lt;a class="reference external" href="http://tinyproxy.github.io/"&gt;Tinyproxy&lt;/a&gt; 等等。&lt;/p&gt;
&lt;p&gt;就寫到這邊，有問題也歡迎大家討論唷！&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id10"&gt;
&lt;h2&gt;補充：小技巧和工具&lt;/h2&gt;
&lt;p&gt;這邊放一些大家在使用 SSH Tunneling 上的小技巧和工具，但細節就請大家自行 Google 囉。&lt;/p&gt;
&lt;div class="section" id="ssh"&gt;
&lt;h3&gt;常用的 SSH 指令參數&lt;/h3&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-N&lt;/span&gt;&lt;/tt&gt;&lt;/dt&gt;
&lt;dd&gt;不要執行任何遠端指令。沒有加這個參數時，建立 Port Forwarding 的同時也會開啟
Remote Shell，讓你可以對 SSH Server 下指令，而這個參數可以讓 Remote Shell
不要打開。&lt;/dd&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-f&lt;/span&gt;&lt;/tt&gt;&lt;/dt&gt;
&lt;dd&gt;讓 &lt;tt class="docutils literal"&gt;ssh&lt;/tt&gt; 指令在背景執行，讓你可以繼續用 Shell 做事情。通常會搭上面的
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-N&lt;/span&gt;&lt;/tt&gt; 使用。&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;div class="section" id="ssh-client"&gt;
&lt;h3&gt;常用的 SSH Client 端設定&lt;/h3&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;註釋&lt;/p&gt;
&lt;p class="last"&gt;設定檔通常在 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;~/.ssh/config&lt;/span&gt;&lt;/tt&gt; 或是 &lt;tt class="docutils literal"&gt;/etc/ssh/ssh_config&lt;/tt&gt;。&lt;/p&gt;
&lt;/div&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;ServerAliveInterval&lt;/tt&gt;&lt;/dt&gt;
&lt;dd&gt;設定一段時間，如果 Client 在這段時間內都沒從 SSH Server 收到資料，就發出一段訊息請 SSH Server 回應。這會讓連線不會呈現閒置狀態，避免防火牆或 Router 切斷你的連線。預設為 &lt;tt class="docutils literal"&gt;0&lt;/tt&gt; ，不會發出任何訊息。&lt;/dd&gt;
&lt;dt&gt;&lt;tt class="docutils literal"&gt;ServerAliveCountMax&lt;/tt&gt;&lt;/dt&gt;
&lt;dd&gt;設定在 SSH Server 沒回應的情況下，Client 最多要送幾次請求回應的訊息（上面提到的那個）。達到此次數後，Client 就會切斷與 SSH Server 之間的連線。這個主要是避免在 SSH Server 已經無法連線後，Client 還不斷送出請求回應的情況。預設為 &lt;tt class="docutils literal"&gt;3&lt;/tt&gt; 。&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;div class="section" id="autossh-ssh"&gt;
&lt;h3&gt;autossh：自動重啟 SSH 連線&lt;/h3&gt;
&lt;p&gt;&lt;a class="reference external" href="https://linux.die.net/man/1/autossh"&gt;autossh&lt;/a&gt;
是一支可以幫你監控 SSH 連線狀態並自動重連的程式。如果你的網路狀況很糟糕，或是防火牆會三不五時把你斷線，他可以幫你自動重啟連線。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fail2ban"&gt;
&lt;h3&gt;Fail2Ban：阻擋不明連線&lt;/h3&gt;
&lt;p&gt;&lt;a class="reference external" href="https://www.fail2ban.org/wiki/index.php/Main_Page"&gt;Fail2Ban&lt;/a&gt;
可以幫你阻擋不明連線，原理就是去監看 SSH 服務的 log 來偵測登入失敗的 IP，然後在這些 IP 的失敗次數達到一定值時，利用防火牆來暫時停止該 IP 的連線請求，過一定時間後再恢復。可以拿來擋掉最基本的暴力攻擊。&lt;/p&gt;
&lt;p&gt;如果你租了線上主機來玩，建議最少要裝 Fail2Ban 來保護你的 SSH Server。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="port-knocking-ssh-port"&gt;
&lt;h3&gt;Port Knocking：有條件的開啟 SSH Port&lt;/h3&gt;
&lt;p&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Port_knocking"&gt;Port Knocking&lt;/a&gt;
指的是 Client 必須用特殊的順序來對 SSH Server 上的某些 Port 發出連線請求後，SSH Server 才會開放 Client 連線的技巧（比如依序對 Port 1000、2000、3000 發出請求，才會對你開放 Port 22）。這樣的好處是平時 Port 22 就會是關閉的狀態，讓攻擊者以為 SSH 沒有開放，減少被攻擊的機會。我沒用過，但看起來會搭配其他服務（像 &lt;a class="reference external" href="https://linux.die.net/man/1/knockd"&gt;knockd&lt;/a&gt; ）一起用。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="references"&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;man ssh&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://zh.wikipedia.org/wiki/SOCKS"&gt;SOCKS (Wiki)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.ssh.com/ssh/tunneling/example"&gt;SSH Port Forwarding Example&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.booleanworld.com/guide-ssh-port-forwarding-tunnelling/"&gt;A Guide to SSH Port Forwarding/Tunnelling&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="SSH, Linux"></category><category term="SSH"></category><category term="Linux"></category><category term="Tunneling"></category><category term="Port Forwarding"></category></entry><entry><title>用 Pelican 寫中文文章</title><link href="https://johnliu55.tw/when-pelican-meets-cjk.html" rel="alternate"></link><published>2019-05-25T00:00:00+08:00</published><updated>2019-06-08T00:00:00+08:00</updated><author><name>John Liu</name></author><id>tag:johnliu55.tw,2019-05-25:/when-pelican-meets-cjk.html</id><summary type="html">&lt;p class="first last"&gt;用Pelican與reStructuredText寫中文文章遇到了空白、換行等等格式問題，
所以自己寫了一個Pelican Plugin來解決這些問題。&lt;/p&gt;
</summary><content type="html">&lt;div class="admonition admonition-"&gt;
&lt;p class="first admonition-title"&gt;變更記錄&lt;/p&gt;
&lt;dl class="last docutils"&gt;
&lt;dt&gt;2019-06-08&lt;/dt&gt;
&lt;dd&gt;修正「解决 jekyll 中文换行变成空格的问题」這篇文章的連結。&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;p&gt;想寫 Blog 很久了，一直覺得該找個地方記錄一下腦子裡的想法，不然我記性超級差，隔天就忘了自己到底在忙什麼。&lt;/p&gt;
&lt;p&gt;那要用什麼寫？&lt;/p&gt;
&lt;p&gt;一般的 Blog 服務當然是不考慮，對&lt;strong&gt;時常要放程式碼&lt;/strong&gt;的人來說完全不適合。&lt;/p&gt;
&lt;p&gt;在很潮的 Medium 上寫過一篇文章，沒有原生支援 Code Syntax Highlighting
讓人非常消火，每次都得用 GitHub Gist 放程式碼實在有點麻煩。而且用 Vim + Markup Language 寫文件寫習慣了，對必須用滑鼠改格式這件事覺得不太順手。&lt;/p&gt;
&lt;p&gt;Google 了一下，身為 Python 工程師及愛好者，用 &lt;a class="reference external" href="https://docs.getpelican.com/en/stable/"&gt;Pelican&lt;/a&gt; 寫然後架在 GitHub Pages
上似乎是最好的選擇：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;用 Python 寫的，可以用 Python 擴充和修改功能&lt;/li&gt;
&lt;li&gt;支援 reStructuredText 及 Markdown&lt;/li&gt;
&lt;li&gt;支援 Disqus 和 Google Analytic 等其他好用的服務&lt;/li&gt;
&lt;li&gt;支援許多主題： &lt;a class="reference external" href="http://www.pelicanthemes.com/"&gt;Pelican Themes&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;讚，那就開始寫吧！&lt;/p&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;當 Pelican 遇上中文&lt;/h2&gt;
&lt;p&gt;平常文件都是用英文在寫，當開始用 reStructuredText 寫起中文立刻覺得不太對勁…好像出現了很多不該出現的空格？&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt=" 詭異的空格們 " src="https://johnliu55.tw/when-pelican-meets-cjk/images/weird-spaces.png" /&gt;
&lt;p class="caption"&gt;詭異的空格們&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h3&gt;換行變成了空格&lt;/h3&gt;
&lt;p&gt;我是龜毛人，原始碼的行數不超過 80 個字元是基本，最多也不能超過 100，所以很長的一個段落會用多行表示：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;我是龜毛人&lt;/span&gt;&lt;span class="err"&gt;，&lt;/span&gt;&lt;span class="n"&gt;原始碼的行數不超過 80 個字元是基本&lt;/span&gt;&lt;span class="err"&gt;，&lt;/span&gt;&lt;span class="n"&gt;最多也不能超過 100&lt;/span&gt;&lt;span class="err"&gt;，&lt;/span&gt;
&lt;span class="n"&gt;所以很長的一個段落會用多行表示&lt;/span&gt;&lt;span class="err"&gt;：&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;reStructuredText 和 Markdown 都會保留這個換行字元到轉換後的 HTML 中：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;我是龜毛人&lt;/span&gt;&lt;span class="err"&gt;，&lt;/span&gt;&lt;span class="n"&gt;原始碼的行數不超過 80 個字元是基本&lt;/span&gt;&lt;span class="err"&gt;，&lt;/span&gt;&lt;span class="n"&gt;最多也不能超過 100&lt;/span&gt;&lt;span class="err"&gt;，&lt;/span&gt;
&lt;span class="n"&gt;所以很長的一個段落會用多行表示&lt;/span&gt;&lt;span class="err"&gt;：&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;而瀏覽器在遇到這樣的換行字元時會將他轉換為空格，因為
&lt;a class="reference external" href="https://www.w3.org/MarkUp/html-spec/html-spec_4.html#SEC4.2.2"&gt;Spec&lt;/a&gt;
就是這樣規定：&lt;/p&gt;
&lt;blockquote&gt;
An HTML user agent should treat end of line in any of its variations as
a word space in all contexts except preformatted text.&lt;/blockquote&gt;
&lt;p&gt;這件事在英文很合理，但到了中文就不合理了，&lt;strong&gt;因為我們不會用空格把文字隔開&lt;/strong&gt;。於是乎，上面的例子瀏覽器會顯示為：&lt;/p&gt;
&lt;blockquote&gt;
我是龜毛人，原始檔的行數不超過 80 個字元是基本，100 則是最大值， 所以很長的一個段落會用多行表示：&lt;/blockquote&gt;
&lt;p&gt;注意到「所以」前面多了一個空格。如果你習慣很好，只有在使用標點符號之後才會換行，那看起來影響不大。但如果換行是介於兩個中文字之間，那就會 像這樣在文字間出現詭異的空格。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="inline-markup"&gt;
&lt;h3&gt;Inline Markup 的空格&lt;/h3&gt;
&lt;p&gt;不像 Markdown，reStructuredText 要求&lt;strong&gt;必須用空格&lt;/strong&gt;
（&lt;a class="reference external" href="http://docutils.sourceforge.net/docs/ref/rst/restructuredtext.html#inline-markup-recognition-rules"&gt;或其他類似功能的字元&lt;/a&gt;）將 Inline Markup
與其他的文字區隔開來：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;This is **inline markup** bold.
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;這樣的空格會被保留到 HTML：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;p&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;This is &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;strong&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;inline markup&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;strong&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; bold.&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;p&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;跟上面提到的一樣，這空格在英文沒差，中文就不行了。不過江湖在走，Workaround 要有，最簡單的方法是自己用 &lt;tt class="docutils literal"&gt;\&lt;/tt&gt; 來「跳脫」這個空格：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;This is\ **inline markup**\ bold.
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;但每次都要手動加入這反斜線實在有點麻煩。如果這空格能自己消失，那該有多好。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bonus"&gt;
&lt;h3&gt;Bonus：中英文間的空格&lt;/h3&gt;
&lt;blockquote&gt;
有研究顯示，打字的時候不喜歡在中文和英文之間加空格的人，感情路都走得很辛苦，有七成的比例會在 34 歲的時候跟自己不愛的人結婚，而其餘三成的人最後只能把遺產留給自己的貓。畢竟愛情跟書寫都需要適時地留白。
—— &lt;a class="reference external" href="https://github.com/vinta/pangu.js"&gt;vinta/pangu.js&lt;/a&gt;&lt;/blockquote&gt;
&lt;p&gt;…這種空格我個人是覺得還可以接受啦，不過如果 Pelican 能自動幫我加上這些空格，那我就不用擔心未來會跟不愛的人結婚了。寫程式真是份偉大的工作。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="pelican-plugin"&gt;
&lt;h2&gt;寫個 Pelican Plugin 吧！&lt;/h2&gt;
&lt;p&gt;原本想說可以從處理 reStructuredText 的函式庫 &lt;a class="reference external" href="http://docutils.sourceforge.net/"&gt;docutils&lt;/a&gt; 下手，無奈功力不夠高深，看不出來到底該怎麼修改他的行為，只好從 Pelican 下手。&lt;/p&gt;
&lt;p&gt;之前提到 Pelican 能夠用 Python 自己擴充功能，而在官方的 &lt;a class="reference external" href="https://github.com/getpelican/pelican-plugins"&gt;pelican-plugins&lt;/a&gt;
列表中搜尋了一下只有 &lt;a class="reference external" href="https://github.com/yuex/cjk-auto-spacing"&gt;cjk-auto-spacing&lt;/a&gt; 能夠自動調整中英文間的空格，但還是沒有解決所有的問題。Google 了一下找到這篇「&lt;a class="reference external" href="http://blog.guorongfei.com/2015/04/25/how-to-fix-the-markdown-newline-blank-problem/"&gt;解决 jekyll 中文换行变成空格的问题&lt;/a&gt;」，但他是用
&lt;a class="reference external" href="https://jekyllrb.com/"&gt;Jekyll&lt;/a&gt; 而不是 Pelican。安捏…不如自己寫一個吧！&lt;/p&gt;
&lt;div class="section" id="id4"&gt;
&lt;h3&gt;Pelican Plugin 的運作方式&lt;/h3&gt;
&lt;blockquote&gt;
Pelican 定義了各種「&lt;strong&gt;信號&lt;/strong&gt;」（Signal），代表了從原始碼到最後生出 HTML 的各個&lt;strong&gt;階段&lt;/strong&gt;。你可以將自己寫的 Python 函式&lt;strong&gt;註冊&lt;/strong&gt;到這些信號上，Pelican 就會在那些&lt;strong&gt;信號對應的階段發生時&lt;/strong&gt;呼叫你的函式，並將當下的狀態或處理的物件傳進這個函式，讓你的函式能夠調整 Pelican 的行為。細節和信號列表請參考 &lt;a class="reference external" href="https://docs.getpelican.com/en/stable/plugins.html"&gt;Pelican Plugin Document&lt;/a&gt; 。&lt;/blockquote&gt;
&lt;p&gt;前面提到了 &lt;a class="reference external" href="https://github.com/yuex/cjk-auto-spacing"&gt;cjk-auto-spacing&lt;/a&gt; ，理所當然拿他來參考一下。它處理的方式是使用信號
&lt;em&gt;content_object_init&lt;/em&gt; 來取得 &lt;tt class="docutils literal"&gt;content_object&lt;/tt&gt; 物件，而這個物件的 &lt;tt class="docutils literal"&gt;_content&lt;/tt&gt;
屬性存放了從 reStructuredText 及 Markdown 原始碼轉換而來的 &lt;strong&gt;HTML&lt;/strong&gt; ，以 &lt;tt class="docutils literal"&gt;str&lt;/tt&gt;
儲存。我們可以根據需求來調整這個 HTML，調整完後再 assign 回 &lt;tt class="docutils literal"&gt;_content&lt;/tt&gt; ，Pelican 就會用這份新的 HTML 繼續之後的工作。&lt;/p&gt;
&lt;p&gt;舉例來說，如果我們想把 HTML 裡的所有 &lt;tt class="docutils literal"&gt;&amp;lt;p&amp;gt;&lt;/tt&gt; Tag 換成 &lt;tt class="docutils literal"&gt;&amp;lt;foo&amp;gt;&lt;/tt&gt; ，可以很快的用
Regular Expression 來達成：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pelican&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;signals&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;process&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;new_content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;lt;(/)?p&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;lt;\1foo&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_content&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;new_content&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;register&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="n"&gt;signals&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;content_object_init&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Pelican 規定每個 Plugin 都必須要有 &lt;tt class="docutils literal"&gt;register&lt;/tt&gt; 函式，目的在指定你需要哪些信號以及他們要觸發的函式。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="pelican-cjk"&gt;
&lt;h2&gt;Pelican-CJK&lt;/h2&gt;
&lt;p&gt;花了些時間用 Regular Expression 刻了一個能夠自動處理以上問題的 Plugin：
&lt;a class="reference external" href="https://github.com/johnliu55tw/pelican-cjk"&gt;pelican-cjk&lt;/a&gt; 。它能夠自動根據你寫的內容調整 HTML，解決上述那些小毛病。&lt;/p&gt;
&lt;p&gt;在開發這個 Plugin 的時候考慮了以下幾點：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;必須支援 reStructuredText 及 Markdown&lt;/li&gt;
&lt;li&gt;不想依賴其他第三方模組&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果要從原始碼（ &lt;tt class="docutils literal"&gt;.md&lt;/tt&gt; 與 &lt;tt class="docutils literal"&gt;.rst&lt;/tt&gt; ）或 Parser 下手，就還得考慮 reStructuredText 和 Markdown 的差異，所以如果兩個都得支援，直接從 HTML 下手會好處理很多。&lt;/p&gt;
&lt;p&gt;而基於第二點，
&lt;a class="reference external" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/"&gt;Beautiful Soup&lt;/a&gt;
等等能夠幫助處理 HTML 的模組也就不考慮了，而 Python 內建的
&lt;a class="reference external" href="https://docs.python.org/3/library/html.parser.html"&gt;HTML Parser&lt;/a&gt; 又太陽春，所以最後我直接用 Regex 來處理。但這不免有些小問題：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;無法判斷目前要調整的文字屬於那種區塊。reStructuredText 和 Markdown 都有所謂的「Literal Block」，在這個區塊內是不會處理任何標記的。
&lt;strong&gt;但因為程式無法根據 HTML 判斷區塊，它一樣會調整這個區塊內的文字。&lt;/strong&gt;
不過 Literal Block 通常是用來放範例程式碼的，比較不會出現中英混用的情況，所以就我認為影響不大。&lt;/li&gt;
&lt;li&gt;透過上述信號拿到的 HTML &lt;strong&gt;不包含文章的標題&lt;/strong&gt;，所以標題無法調整，得自己加入中英文間的空格。這應該可以透過其他信號取得，但我還沒研究。&lt;/li&gt;
&lt;li&gt;為了簡單起見，我寫的 Regex 不會針對以下情況調整空格：&lt;ul&gt;
&lt;li&gt;巢狀 Inline Markup：reStructuredText 不允許這種情況，也就是說 HTML 中不會出現
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;English&amp;lt;em&amp;gt;&amp;lt;strong&amp;gt;斜體又粗體&amp;lt;/strong&amp;gt;&amp;lt;/em&amp;gt;&lt;/span&gt;&lt;/tt&gt; 這樣的東西。但 Markdown 允許，所以這是有機會出現的。以這個例子來說，「English」與「斜體又粗體」間就不會自動加空格。&lt;/li&gt;
&lt;li&gt;連續 Inline Markup： &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;&amp;lt;em&amp;gt;English&amp;lt;/em&amp;gt;&amp;lt;strong&amp;gt;很強&amp;lt;/strong&amp;gt;&lt;/span&gt;&lt;/tt&gt;
連續的兩個 Inline Markup 也需要額外判斷，而且使用情況也不多，所以在此也不考慮。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;希望這個 Plugin 能夠幫助更多跟我一樣毛很多的人，如果大家有什麼更好的方法也歡迎一起討論。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="references"&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/vinta/pangu.js"&gt;vinta/pangu.js&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://blog.guorongfei.com/2015/04/25/how-to-fix-the-markdown-newline-blank-problem/"&gt;解决 jekyll 中文换行变成空格的问题&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="Python"></category><category term="Python"></category><category term="Pelican"></category></entry><entry><title>用 Python 控制其他行程的 TTY 終端裝置</title><link href="https://johnliu55.tw/use-python-to-control-other-process-tty.html" rel="alternate"></link><published>2018-04-11T00:00:00+08:00</published><updated>2018-04-11T00:00:00+08:00</updated><author><name>John Liu</name></author><id>tag:johnliu55.tw,2018-04-11:/use-python-to-control-other-process-tty.html</id><summary type="html">&lt;p class="first last"&gt;這篇文章會稍微解釋Unix的TTY系統以及Pseudo Terminal的概念，
接著討論如何使用Python的 &lt;tt class="docutils literal"&gt;pty&lt;/tt&gt; 模組中的 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt;
來建立並控制子行程的TTY系統，
最後用Python來實作控制 &lt;em&gt;madplay&lt;/em&gt; 這個CLI MP3 Player。&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="foreword"&gt;
&lt;h2&gt;Foreword&lt;/h2&gt;
&lt;p&gt;這篇文章會稍微解釋 Unix 的 TTY 系統以及 Pseudo Terminal 的概念，接著討論如何使用 Python 的 &lt;tt class="docutils literal"&gt;pty&lt;/tt&gt; 模組中的 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt;
來建立並控制子行程的 TTY 系統，最後用 Python 來實作控制 &lt;em&gt;madplay&lt;/em&gt; 這個 CLI MP3 Player。&lt;/p&gt;
&lt;p&gt;有問題歡迎大家詢問，有任何錯誤也請大家幫忙指正 :D&lt;/p&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="python-mp3-player"&gt;
&lt;h2&gt;Python MP3 Player&lt;/h2&gt;
&lt;p&gt;這幾天在玩 &lt;a class="reference external" href="https://www.seeedstudio.com/ReSpeaker-Core-Based-On-MT7688-and-OpenWRT-p-2716.html"&gt;ReSpeaker&lt;/a&gt; （一個基於 MT7688 的聲控裝置開發板）遇到了個問題：在 ReSpeaker 中要如何使用 Python 播放 MP3 檔案？&lt;/p&gt;
&lt;p&gt;好在 ReSpeaker 上已有 &lt;em&gt;madplay&lt;/em&gt; 這個指令，能夠直接播放 MP3：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ madplay MP3_FILE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;更讚的是只要加上 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--tty-control&lt;/span&gt;&lt;/tt&gt; 就能直接控制播放狀態！&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ madplay MP3_FILE --tty-control MP3_FILE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;例如按下 &lt;tt class="docutils literal"&gt;p&lt;/tt&gt; 就能控制音樂播放的暫停 / 繼續。很好！這樣就可以用 &lt;tt class="docutils literal"&gt;subprocess&lt;/tt&gt; 模組啟動 madplay 來控制音樂播放啦！然後&lt;strong&gt;對這個子行程的 stdin&lt;/strong&gt; 寫入這些控制用的鍵應該就能控制音樂播放了吧？至少我是這樣想的…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-mystery-tty"&gt;
&lt;h2&gt;The mystery TTY&lt;/h2&gt;
&lt;p&gt;俗話說的好，代誌往往不是憨人所想的那麼簡單，試了幾回後發現竟然沒效？！一氣之下翻了翻 madplay 的原始碼，發現 &lt;tt class="docutils literal"&gt;player.c&lt;/tt&gt;
裡有些跟 &lt;em&gt;TTY&lt;/em&gt; 這玩意兒有關的程式碼：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="cp"&gt;# define TTY_DEVICE &amp;quot;/dev/tty&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="n"&gt;tty_fd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;TTY_DEVICE&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;O_RDONLY&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tty_fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;玩過 Linux 的朋友們應該對 TTY 這個字有強烈的熟悉感，好像三不五時就會看到這東西出現。於是我拿他去 Google 後得到下面幾個結論：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;TTY 源自於 &lt;em&gt;Teletype&lt;/em&gt; 這個單字，中文稱為&lt;strong&gt;電傳打字機&lt;/strong&gt;，是古早年代用來遠距離傳遞文字資訊用的機器以及機制。&lt;/li&gt;
&lt;li&gt;很久很久以前並沒有 PC — Personal Computer 這種東西，有的只是一台螢幕加鍵盤組成的終端機，透過串列埠等等的傳輸方式與一台中央主機溝通，進行控制與運算的工作。Unix 下的 TTY 裝置概念就是從這裡出現的，細節可參考我列在最後面的 References。&lt;/li&gt;
&lt;li&gt;TTY 裝置架構中有一層叫做 &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Line_discipline"&gt;Line discipline&lt;/a&gt; 。這東西介於軟體層（行程接收到的資訊）和驅動層（實際上與硬體打交道那一層）間，負責對從其中一層傳遞過來的資訊做前處理，再傳到另一層。舉例像是 Line editing（Buffering、Backspace、Echoing、移動游標等…）、字元轉換（ &lt;tt class="docutils literal"&gt;\n&lt;/tt&gt; 與 &lt;tt class="docutils literal"&gt;\r\n&lt;/tt&gt; 互相轉換…）、控制字元轉換為信號（ASCII 0x03→SIGINT）等等的功能。&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;/dev/tty&lt;/tt&gt; 裝置代表的是&lt;strong&gt;目前行程所連接著的終端（Terminal）裝置&lt;/strong&gt;。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;從 &lt;tt class="docutils literal"&gt;player.c&lt;/tt&gt; 中的程式碼看起來，madplay 是直接從 /dev/tty 這個裝置讀取鍵盤輸入，而不是從 stdin 讀取。聽起來有點多此一舉，但這麼做有個好處：&lt;/p&gt;
&lt;blockquote&gt;
一個行程可以在從 stdin 接收資料的同時，接收來自鍵盤的訊息。&lt;/blockquote&gt;
&lt;p&gt;舉例來說， &lt;tt class="docutils literal"&gt;cat MP3_FILE | madplay &lt;span class="pre"&gt;-—tty-control&lt;/span&gt; -&lt;/tt&gt;
這串指令中的 madplay 會讀取 stdin，而 &lt;tt class="docutils literal"&gt;cat MP3_FILE&lt;/tt&gt; 這個指令會將 &lt;tt class="docutils literal"&gt;MP3_FILE&lt;/tt&gt;
這個檔案輸出到 stdout，中間我們藉由 &lt;tt class="docutils literal"&gt;|&lt;/tt&gt; 來將這些資料導向至 madplay 進行播放。在這一連串事情發生的同時，使用者同樣可以用鍵盤控制播放狀態。&lt;/p&gt;
&lt;p&gt;既然如此，那有沒有辦法控制一個行程所連接著的終端裝置呢？更重要的是，Python 做的到嗎？&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pseudo-terminal"&gt;
&lt;h2&gt;Pseudo Terminal&lt;/h2&gt;
&lt;p&gt;當然可以！針對控制一個行程的終端，Python 標準函式庫提供了
&lt;a class="reference external" href="https://docs.python.org/3/library/pty.html"&gt;pty&lt;/a&gt; 這個模組來處理與 &lt;em&gt;Pseudo Terminal&lt;/em&gt; 有關的概念。那什麼是 Pseudo Terminal？&lt;/p&gt;
&lt;p&gt;現在 PC 當道，基本上已經不存在過去那種「使用（不具運算能力的）終端連上一台電腦進行控制與運算」的情境。但是我們想把 TTY 這個概念延續到現在繼續用該怎麼辦？於是就出現了 Pseudo Terminal（注意：跟 Virtual Terminal 是不同的概念）。&lt;/p&gt;
&lt;p&gt;關於他的定義，我們直接來看一下
&lt;a class="reference external" href="https://linux.die.net/man/7/pty"&gt;pty 的 Linux man page&lt;/a&gt; ：&lt;/p&gt;
&lt;blockquote&gt;
A pseudoterminal (sometimes abbreviated “pty”) is a pair of virtual
character devices that provide a bidirectional communication channel.
One end of the channel is called the master; the other end is called the
slave. The slave end of the pseudoterminal provides an interface that
behaves exactly like a classical terminal. A process that expects to be
connected to a terminal, can open the slave end of a pseudoterminal and
then be driven by a program that has opened the master end. Anything that is
written on the master end is provided to the process on the slave end as
though it was input typed on a terminal.&lt;/blockquote&gt;
&lt;p&gt;Pseudo Terminal 建立了兩個虛擬字元裝置，分別稱為 master 與 slave，提供了一個雙向溝通的管道。讀寫 slave 端的的行程可以把該 slave 裝置完全當作是一個普通的 TTY 裝置軟體層，具有終端的行為模式。而另一個行程則能對 master 端進行讀寫，把 master 端當作是 TTY 裝置的硬體層。&lt;strong&gt;而其中對 master 或 slave 端寫入的資訊，同樣會經過 line discipline 的處理，再進到另一端。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;借 &lt;a class="reference external" href="http://www.linusakesson.net/programming/tty/"&gt;The TTY demystified&lt;/a&gt; 這篇文章中的圖來說明：&lt;/p&gt;
&lt;img alt="How xterm works" src="https://johnliu55.tw/use-python-to-control-other-process-tty/images/how-xterm-works.png" /&gt;
&lt;p&gt;換句話說，就是&lt;strong&gt;串列埠接頭變成了一個 file descriptor&lt;/strong&gt; 。於是呢，像 xterm 之類的終端模擬器（Terminal Emulator）就能夠以程式的方式去模擬一台古早年代終端機，將使用者使用終端機對串列埠寫入及讀取的行為模式，改為&lt;strong&gt;寫入及讀取這個 file descriptor&lt;/strong&gt; ，在同一台機器上模擬終端的輸入及輸出。&lt;/p&gt;
&lt;p&gt;大概了解了 Pseudo Terminal，接下來看看 Python 怎麼做這件事。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-pty-module"&gt;
&lt;h2&gt;The pty module&lt;/h2&gt;
&lt;p&gt;一句話解釋完 pty 模組：&lt;/p&gt;
&lt;blockquote&gt;
starting another process and being able to write to and read from its
controlling terminal programmatically.&lt;/blockquote&gt;
&lt;p&gt;Bingo，這聽起來就是我想要的啊！其中我們會需要用到 &lt;tt class="docutils literal"&gt;pty.fork&lt;/tt&gt; 這個函式：&lt;/p&gt;
&lt;blockquote&gt;
&lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt; ：Fork 一個子行程，並讓該子行程的控制終端接上一個 Pseudo Terminal 的 slave 端。父行程會得到該 Pseudo Terminal 的 master 端，以一個 file descriptor 表示。這個函式的回傳值是個 tuple：(pid, fd)，子行程得到的 pid 會是 0，而父行程會得到一個非 0 的值，為子行程的 pid。&lt;/blockquote&gt;
&lt;p&gt;換句話說，我們可以啟動一個子行程，並使用父行程來控制該子行程的終端裝置，也就是 /dev/tty。在實做之前，先來測試一下 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt; ：&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;&lt;span class="normal"&gt; 1&lt;/span&gt;
&lt;span class="normal"&gt; 2&lt;/span&gt;
&lt;span class="normal"&gt; 3&lt;/span&gt;
&lt;span class="normal"&gt; 4&lt;/span&gt;
&lt;span class="normal"&gt; 5&lt;/span&gt;
&lt;span class="normal"&gt; 6&lt;/span&gt;
&lt;span class="normal"&gt; 7&lt;/span&gt;
&lt;span class="normal"&gt; 8&lt;/span&gt;
&lt;span class="normal"&gt; 9&lt;/span&gt;
&lt;span class="normal"&gt;10&lt;/span&gt;
&lt;span class="normal"&gt;11&lt;/span&gt;
&lt;span class="normal"&gt;12&lt;/span&gt;
&lt;span class="normal"&gt;13&lt;/span&gt;
&lt;span class="normal"&gt;14&lt;/span&gt;
&lt;span class="normal"&gt;15&lt;/span&gt;
&lt;span class="normal"&gt;16&lt;/span&gt;
&lt;span class="normal"&gt;17&lt;/span&gt;
&lt;span class="normal"&gt;18&lt;/span&gt;
&lt;span class="normal"&gt;19&lt;/span&gt;
&lt;span class="normal"&gt;20&lt;/span&gt;
&lt;span class="normal"&gt;21&lt;/span&gt;
&lt;span class="normal"&gt;22&lt;/span&gt;
&lt;span class="normal"&gt;23&lt;/span&gt;
&lt;span class="normal"&gt;24&lt;/span&gt;
&lt;span class="normal"&gt;25&lt;/span&gt;
&lt;span class="normal"&gt;26&lt;/span&gt;
&lt;span class="normal"&gt;27&lt;/span&gt;
&lt;span class="normal"&gt;28&lt;/span&gt;
&lt;span class="normal"&gt;29&lt;/span&gt;
&lt;span class="normal"&gt;30&lt;/span&gt;
&lt;span class="normal"&gt;31&lt;/span&gt;
&lt;span class="normal"&gt;32&lt;/span&gt;
&lt;span class="normal"&gt;33&lt;/span&gt;
&lt;span class="normal"&gt;34&lt;/span&gt;
&lt;span class="normal"&gt;35&lt;/span&gt;
&lt;span class="normal"&gt;36&lt;/span&gt;
&lt;span class="normal"&gt;37&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pty&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;


&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pty&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="c1"&gt;# Child process&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Hello World!&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;KeyboardInterrupt&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;SIGINT Received!&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Parent wait for 1 sec then write 0x03...&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Parent write 0x03&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\x03&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# Read until EOF or Input/Output Error&lt;/span&gt;
    &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;OSError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;break&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;
            &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;break&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Parent read from pty fd: &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;repr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Parent wait for child process &lt;/span&gt;&lt;span class="si"&gt;{!r}&lt;/span&gt;&lt;span class="s1"&gt; to exit...&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;status&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitpid&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Parent exit&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p&gt;執行以上程式碼後應該會出現以下結果 (Ubuntu 16.04 with Python 3.5)：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ python3.5 pty_fork_test.py
Parent &lt;span class="nb"&gt;wait&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt; sec &lt;span class="k"&gt;then&lt;/span&gt; write 0x03...
Parent write 0x03
Parent &lt;span class="nb"&gt;read&lt;/span&gt; from pty fd: b&lt;span class="s1"&gt;&amp;#39;Hello World!\r\n^CSIGINT Received!\r\n&amp;#39;&lt;/span&gt;
Parent &lt;span class="nb"&gt;wait&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; child process &lt;span class="m"&gt;17676&lt;/span&gt; to exit...
Parent &lt;span class="nb"&gt;exit&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;這段程式碼展示了父行程如何使用 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt;
回傳的 file descriptor 與子行程溝通的過程：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;子行程的 stdout 連接到 slave 端，因此子行程對 stdout 寫入的內容可以被父行程透過讀取 master 端，也就是 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt; 回傳的 file descriptor，來接收。因此，父行程能夠讀取到子行程對 stdout 寫入的 &lt;tt class="docutils literal"&gt;Hello &lt;span class="pre"&gt;World!\n&lt;/span&gt;&lt;/tt&gt; 字串。&lt;/li&gt;
&lt;li&gt;子行程寫入的 &lt;tt class="docutils literal"&gt;Hello World\n&lt;/tt&gt; 到了父行程變成了 &lt;tt class="docutils literal"&gt;Hello World\r\n&lt;/tt&gt; ，多了一個 &lt;em&gt;Carriage Return&lt;/em&gt; &lt;tt class="docutils literal"&gt;\r&lt;/tt&gt; 字元，這是 Line discipline 正在作用的結果。這證明了中間並不是只有單純的資料交換，而是 Linux 的 TTY 系統在作動中。&lt;/li&gt;
&lt;li&gt;父行程對 file descriptor 寫入數值 &lt;tt class="docutils literal"&gt;0x03&lt;/tt&gt; 後，到了子行程變成了 SIGINT 信號而被 Python 捕捉為 &lt;tt class="docutils literal"&gt;KeyboardInterrupt&lt;/tt&gt; 例外，接著子行程對 stdout 寫入 &lt;tt class="docutils literal"&gt;SIGINT &lt;span class="pre"&gt;Received!\n&lt;/span&gt;&lt;/tt&gt; 字串，然後被父行程讀取並顯示為 &lt;tt class="docutils literal"&gt;^CSIGINT &lt;span class="pre"&gt;Received!\r\n&lt;/span&gt;&lt;/tt&gt; 。這也證明了 Line discipline 以及 TTY 系統的作用。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上是對 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt; 做的簡單測試。接下來來實做啦！&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-mp3-player-powered-by-madplay"&gt;
&lt;h2&gt;The MP3 player powered by madplay&lt;/h2&gt;
&lt;p&gt;針對「使用 Python + madplay 控制 MP3 檔案的播放」這件事，可以這樣做：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;使用 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt; Fork 出一個子行程，讓該子行程使用 Python 的 &lt;tt class="docutils literal"&gt;os.exec*&lt;/tt&gt;
系列函式來啟動 madplay 取代目前行程，並播放一個 MP3 檔案。&lt;/li&gt;
&lt;li&gt;父行程利用 &lt;tt class="docutils literal"&gt;pty.fork()&lt;/tt&gt; 取得的 file descriptor 來控制子行程的終端裝置，進而控制 madplay。&lt;/li&gt;
&lt;li&gt;沒事得清清 file descriptor 的 receive buffer，避免讓子行程持續寫入而塞爆 buffer（這是我自己想的，實際上可能不用，但買個保險嘛）。&lt;/li&gt;
&lt;li&gt;子行程的 madplay 播放完畢後必須通知父行程，這時父行程必須使用 &lt;tt class="docutils literal"&gt;os.wait&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;os.waitpid&lt;/tt&gt; 來收拾子行程，否則會產生彊屍行程。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;不囉嗦，直接上 code：&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;&lt;span class="normal"&gt;  1&lt;/span&gt;
&lt;span class="normal"&gt;  2&lt;/span&gt;
&lt;span class="normal"&gt;  3&lt;/span&gt;
&lt;span class="normal"&gt;  4&lt;/span&gt;
&lt;span class="normal"&gt;  5&lt;/span&gt;
&lt;span class="normal"&gt;  6&lt;/span&gt;
&lt;span class="normal"&gt;  7&lt;/span&gt;
&lt;span class="normal"&gt;  8&lt;/span&gt;
&lt;span class="normal"&gt;  9&lt;/span&gt;
&lt;span class="normal"&gt; 10&lt;/span&gt;
&lt;span class="normal"&gt; 11&lt;/span&gt;
&lt;span class="normal"&gt; 12&lt;/span&gt;
&lt;span class="normal"&gt; 13&lt;/span&gt;
&lt;span class="normal"&gt; 14&lt;/span&gt;
&lt;span class="normal"&gt; 15&lt;/span&gt;
&lt;span class="normal"&gt; 16&lt;/span&gt;
&lt;span class="normal"&gt; 17&lt;/span&gt;
&lt;span class="normal"&gt; 18&lt;/span&gt;
&lt;span class="normal"&gt; 19&lt;/span&gt;
&lt;span class="normal"&gt; 20&lt;/span&gt;
&lt;span class="normal"&gt; 21&lt;/span&gt;
&lt;span class="normal"&gt; 22&lt;/span&gt;
&lt;span class="normal"&gt; 23&lt;/span&gt;
&lt;span class="normal"&gt; 24&lt;/span&gt;
&lt;span class="normal"&gt; 25&lt;/span&gt;
&lt;span class="normal"&gt; 26&lt;/span&gt;
&lt;span class="normal"&gt; 27&lt;/span&gt;
&lt;span class="normal"&gt; 28&lt;/span&gt;
&lt;span class="normal"&gt; 29&lt;/span&gt;
&lt;span class="normal"&gt; 30&lt;/span&gt;
&lt;span class="normal"&gt; 31&lt;/span&gt;
&lt;span class="normal"&gt; 32&lt;/span&gt;
&lt;span class="normal"&gt; 33&lt;/span&gt;
&lt;span class="normal"&gt; 34&lt;/span&gt;
&lt;span class="normal"&gt; 35&lt;/span&gt;
&lt;span class="normal"&gt; 36&lt;/span&gt;
&lt;span class="normal"&gt; 37&lt;/span&gt;
&lt;span class="normal"&gt; 38&lt;/span&gt;
&lt;span class="normal"&gt; 39&lt;/span&gt;
&lt;span class="normal"&gt; 40&lt;/span&gt;
&lt;span class="normal"&gt; 41&lt;/span&gt;
&lt;span class="normal"&gt; 42&lt;/span&gt;
&lt;span class="normal"&gt; 43&lt;/span&gt;
&lt;span class="normal"&gt; 44&lt;/span&gt;
&lt;span class="normal"&gt; 45&lt;/span&gt;
&lt;span class="normal"&gt; 46&lt;/span&gt;
&lt;span class="normal"&gt; 47&lt;/span&gt;
&lt;span class="normal"&gt; 48&lt;/span&gt;
&lt;span class="normal"&gt; 49&lt;/span&gt;
&lt;span class="normal"&gt; 50&lt;/span&gt;
&lt;span class="normal"&gt; 51&lt;/span&gt;
&lt;span class="normal"&gt; 52&lt;/span&gt;
&lt;span class="normal"&gt; 53&lt;/span&gt;
&lt;span class="normal"&gt; 54&lt;/span&gt;
&lt;span class="normal"&gt; 55&lt;/span&gt;
&lt;span class="normal"&gt; 56&lt;/span&gt;
&lt;span class="normal"&gt; 57&lt;/span&gt;
&lt;span class="normal"&gt; 58&lt;/span&gt;
&lt;span class="normal"&gt; 59&lt;/span&gt;
&lt;span class="normal"&gt; 60&lt;/span&gt;
&lt;span class="normal"&gt; 61&lt;/span&gt;
&lt;span class="normal"&gt; 62&lt;/span&gt;
&lt;span class="normal"&gt; 63&lt;/span&gt;
&lt;span class="normal"&gt; 64&lt;/span&gt;
&lt;span class="normal"&gt; 65&lt;/span&gt;
&lt;span class="normal"&gt; 66&lt;/span&gt;
&lt;span class="normal"&gt; 67&lt;/span&gt;
&lt;span class="normal"&gt; 68&lt;/span&gt;
&lt;span class="normal"&gt; 69&lt;/span&gt;
&lt;span class="normal"&gt; 70&lt;/span&gt;
&lt;span class="normal"&gt; 71&lt;/span&gt;
&lt;span class="normal"&gt; 72&lt;/span&gt;
&lt;span class="normal"&gt; 73&lt;/span&gt;
&lt;span class="normal"&gt; 74&lt;/span&gt;
&lt;span class="normal"&gt; 75&lt;/span&gt;
&lt;span class="normal"&gt; 76&lt;/span&gt;
&lt;span class="normal"&gt; 77&lt;/span&gt;
&lt;span class="normal"&gt; 78&lt;/span&gt;
&lt;span class="normal"&gt; 79&lt;/span&gt;
&lt;span class="normal"&gt; 80&lt;/span&gt;
&lt;span class="normal"&gt; 81&lt;/span&gt;
&lt;span class="normal"&gt; 82&lt;/span&gt;
&lt;span class="normal"&gt; 83&lt;/span&gt;
&lt;span class="normal"&gt; 84&lt;/span&gt;
&lt;span class="normal"&gt; 85&lt;/span&gt;
&lt;span class="normal"&gt; 86&lt;/span&gt;
&lt;span class="normal"&gt; 87&lt;/span&gt;
&lt;span class="normal"&gt; 88&lt;/span&gt;
&lt;span class="normal"&gt; 89&lt;/span&gt;
&lt;span class="normal"&gt; 90&lt;/span&gt;
&lt;span class="normal"&gt; 91&lt;/span&gt;
&lt;span class="normal"&gt; 92&lt;/span&gt;
&lt;span class="normal"&gt; 93&lt;/span&gt;
&lt;span class="normal"&gt; 94&lt;/span&gt;
&lt;span class="normal"&gt; 95&lt;/span&gt;
&lt;span class="normal"&gt; 96&lt;/span&gt;
&lt;span class="normal"&gt; 97&lt;/span&gt;
&lt;span class="normal"&gt; 98&lt;/span&gt;
&lt;span class="normal"&gt; 99&lt;/span&gt;
&lt;span class="normal"&gt;100&lt;/span&gt;
&lt;span class="normal"&gt;101&lt;/span&gt;
&lt;span class="normal"&gt;102&lt;/span&gt;
&lt;span class="normal"&gt;103&lt;/span&gt;
&lt;span class="normal"&gt;104&lt;/span&gt;
&lt;span class="normal"&gt;105&lt;/span&gt;
&lt;span class="normal"&gt;106&lt;/span&gt;
&lt;span class="normal"&gt;107&lt;/span&gt;
&lt;span class="normal"&gt;108&lt;/span&gt;
&lt;span class="normal"&gt;109&lt;/span&gt;
&lt;span class="normal"&gt;110&lt;/span&gt;
&lt;span class="normal"&gt;111&lt;/span&gt;
&lt;span class="normal"&gt;112&lt;/span&gt;
&lt;span class="normal"&gt;113&lt;/span&gt;
&lt;span class="normal"&gt;114&lt;/span&gt;
&lt;span class="normal"&gt;115&lt;/span&gt;
&lt;span class="normal"&gt;116&lt;/span&gt;
&lt;span class="normal"&gt;117&lt;/span&gt;
&lt;span class="normal"&gt;118&lt;/span&gt;
&lt;span class="normal"&gt;119&lt;/span&gt;
&lt;span class="normal"&gt;120&lt;/span&gt;
&lt;span class="normal"&gt;121&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;logging&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;select&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;signal&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pty&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;


&lt;span class="n"&gt;logger&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;logging&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getLogger&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="vm"&gt;__name__&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;Exception&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Base error&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ReadTimeout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Polling timeout&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;PlayerState&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;The state of the player&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;PLAY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;play&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;PAUSE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;pause&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;STOP&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;stop&amp;#39;&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Mp3FilePlayer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;file_path&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;file_path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;file_path&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;STOP&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;poller&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;select&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;poll&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_start_play&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;This method forks a child process and start exec &amp;#39;madplay&amp;#39; to play&lt;/span&gt;
&lt;span class="sd"&gt;            the mp3 file. Since &amp;#39;madplay&amp;#39; can ONLY be controlled by tty, we have&lt;/span&gt;
&lt;span class="sd"&gt;            to use pty.fork and use the return fd in the parent process (which&lt;/span&gt;
&lt;span class="sd"&gt;            connects the child&amp;#39;s controlling terminal) to control the playback.&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="c1"&gt;# Register SIGCHLD to get notified when the child process terminated&lt;/span&gt;
        &lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SIGCHLD&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_sigchld_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pty&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# Child process. Exec madplay&lt;/span&gt;
            &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execl&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/usr/bin/madplay&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;--tty-control&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;file_path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# Parent process&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;fd&lt;/span&gt;
            &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Forked child TTY fd: &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt;
            &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Forked child PID: &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_clear_tty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_read_tty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Read the TTY fd by n bytes or raise ReadTimeout if reached specified timeout.&lt;/span&gt;
&lt;span class="sd"&gt;            The timeout value is in milliseconds.&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;poller&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;register&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;select&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;POLLIN&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;events&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;poller&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;poll&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;poller&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;unregister&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c1"&gt;# Immediately after the polling&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;events&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;ReadTimeout&lt;/span&gt;

        &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;events&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Number of polled events != 1&amp;#39;&lt;/span&gt;

        &lt;span class="n"&gt;fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;event&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;events&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;event&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;select&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;POLLIN&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Unexpected polled event: &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_clear_tty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Clearing the TTY fd. Preventing the receiving buffer to overflow.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# Keep reading until timeout, which means nothing more to read.&lt;/span&gt;
            &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_read_tty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;ReadTimeout&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_sigchld_handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;signum&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Handler function of SIGCHLD&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;SIGCHLD signal received.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;play&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Start the playback or resume from pausing&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;STOP&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_start_play&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PLAY&lt;/span&gt;
        &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PAUSE&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;p&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_clear_tty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PLAY&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;pass&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;pause&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Pause the playback&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PLAY&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_tty_fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;p&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_clear_tty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PAUSE&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;pass&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Stop the playback. This will stop the child process.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;STOP&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# Unregister the signal (set to SIG_DFL) to prevent recusively calling stop()&lt;/span&gt;
            &lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SIGCHLD&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SIG_DFL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

            &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Kill pid &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
            &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kill&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SIGTERM&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Wait pid &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
            &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;waitpid&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Child process &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt; died.&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child_pid&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;player_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PlayerState&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;STOP&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p&gt;這段程式碼定義了類別 &lt;tt class="docutils literal"&gt;Mp3FilePlayer&lt;/tt&gt; 來控制播放。以下是幾個重點：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Mp3FilePlayer&lt;/tt&gt; 定義了 &lt;tt class="docutils literal"&gt;play&lt;/tt&gt; ， &lt;tt class="docutils literal"&gt;pause&lt;/tt&gt; 及 &lt;tt class="docutils literal"&gt;stop&lt;/tt&gt;
這三個方法來控制 MP3 檔案的播放、暫停及停止。&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;stop&lt;/tt&gt; 方法會藉由送出 SIGTERM 信號來停掉子行程，並使用 &lt;tt class="docutils literal"&gt;waitpid()&lt;/tt&gt;
來收拾善後。&lt;/li&gt;
&lt;li&gt;使用 &lt;tt class="docutils literal"&gt;select.poll()&lt;/tt&gt; ，而非直接使用 &lt;tt class="docutils literal"&gt;os.read()&lt;/tt&gt;
直接讀取 file descriptor。原因是我需要對讀取這件事設定 timeout，而 &lt;tt class="docutils literal"&gt;os.read()&lt;/tt&gt; 這個函式無法做到。&lt;/li&gt;
&lt;li&gt;設定 &lt;tt class="docutils literal"&gt;Mp3FilePlayer._sigchld_handler&lt;/tt&gt; 方法當 SIGCHLD 信號的處理函式，以便在 madplay 播放完 MP3 檔後，讓父行程呼叫 &lt;tt class="docutils literal"&gt;stop&lt;/tt&gt; 方法來收拾子行程，避免產生彊屍行程。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;Mp3FilePlayer&lt;/tt&gt; 可以這樣使用：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;mp3_player&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Mp3FilePlayer&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Mp3FilePlayer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/tmp/test.mp3&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;play&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# The music should be started. The play method return immediately.&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pause&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# The music should be paused now. The pause method also return&lt;/span&gt;
&lt;span class="c1"&gt;# immediately.&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;play&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# The playback should be resumed from where it was paused.&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# The music should be stopped now.&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;play&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# The music should be started from the beginning.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;經過這幾天的研究總算稍微理解了 TTY 這東西，也理解了如何使用 Python 的 pty 模組來控制其他行程的終端。希望這篇文能幫助大家🎉&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="references"&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.linusakesson.net/programming/tty/"&gt;The TTY demystified&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://unix.stackexchange.com/q/117981"&gt;What are the responsibilities of each Pseudo-Terminal (PTY) component
(software, master side, slave side)?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://olvaffe.blogspot.tw/2009/01/console-io.html"&gt;一千零一夜之 Console I/O&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://zwai.pixnet.net/blog/post/24326951-linux-tty-driver---linux-tty-%E9%A9%85%E5%8B%95%E7%A8%8B%E5%BC%8F"&gt;Linux TTY Driver — Linux TTY 驅動程式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/unix/TypingEOFEffects"&gt;What typing ^D really does on Unix&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.wowotech.net/tty_framework/tty_concept.html"&gt;Linux TTY framework(1)_ 基本概念&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.wowotech.net/tty_framework/application_view.html"&gt;Linux TTY framework(3)_ 从应用的角度看 TTY 设备&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="Python"></category><category term="Python"></category><category term="TTY"></category><category term="Linux"></category></entry></feed>